[gcode_macro PURGE_SERVO]
description: Controla servo de purge com segurança. Uso: PURGE_SERVO POS=OPEN ou POS=CLOSE. Verifica homing e altura mínima antes de abrir.
variable_min_z_height: 50.0    # Altura MÍNIMA necessária para abrir o servo (em mm)
variable_open_angle: 90        # Ângulo para posição aberta
variable_closed_angle: 0       # Ângulo para posição fechada
gcode:
    {% set position = params.POS|default('CLOSE')|upper %}
    
    # Obtém as variáveis configuradas
    {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
    {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
    {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
    
    {% if position == 'OPEN' %}
        # Verifica se os eixos estão homeados
        {% if not 'xyz' in printer.toolhead.homed_axes %}
            RESPOND MSG="ERRO: Eixos não estão homeados! Execute G28 antes de abrir o servo."
        # Verifica se a mesa está na altura mínima
        {% elif printer.toolhead.position.z < min_z %}
            {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
            {% set min_z_str = "%.1f"|format(min_z) %}
            RESPOND MSG="ERRO: Mesa muito baixa! Altura atual: {current_z}mm. Altura mínima necessária: {min_z_str}mm"
        # Tudo OK, pode abrir
        {% else %}
            {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
            SET_SERVO SERVO=purge_servo ANGLE={open_angle}
            RESPOND MSG="Servo purge ABERTO - Altura: {current_z}mm (ângulo: {open_angle}°)"
        {% endif %}
        
    {% elif position == 'CLOSE' %}
        SET_SERVO SERVO=purge_servo ANGLE={closed_angle}
        RESPOND MSG="Servo purge FECHADO (ângulo: {closed_angle}°)"
        
    {% else %}
        RESPOND MSG="ERRO: Posição inválida! Use: POS=OPEN ou POS=CLOSE"
    {% endif %}

# Macros simplificadas para uso rápido
[gcode_macro PURGE_SERVO_OPEN]
description: Abre o servo de purge (com verificações de segurança)
gcode:
    PURGE_SERVO ACTION=OPEN

[gcode_macro PURGE_SERVO_CLOSE]
description: Fecha o servo de purge
gcode:
    PURGE_SERVO ACTION=CLOSE

# Macro para alterar configurações sem reiniciar
[gcode_macro SET_PURGE_SERVO_CONFIG]
description: Configura parâmetros do servo purge
gcode:
    {% if params.MIN_Z %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=min_z_height VALUE={params.MIN_Z|float}
        RESPOND MSG="Altura mínima alterada para: {params.MIN_Z}mm"
    {% endif %}
    
    {% if params.OPEN_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=open_angle VALUE={params.OPEN_ANGLE|int}
        RESPOND MSG="Ângulo de abertura alterado para: {params.OPEN_ANGLE}°"
    {% endif %}
    
    {% if params.CLOSED_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=closed_angle VALUE={params.CLOSED_ANGLE|int}
        RESPOND MSG="Ângulo de fechamento alterado para: {params.CLOSED_ANGLE}°"
    {% endif %}
    
    {% if not params.MIN_Z and not params.OPEN_ANGLE and not params.CLOSED_ANGLE %}
        {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
        {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
        {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
        RESPOND MSG="Configuração atual: MIN_Z={min_z}mm, OPEN_ANGLE={open_angle}°, CLOSED_ANGLE={closed_angle}°"
    {% endif %}
[gcode_macro PURGE_SERVO]
description: Controla servo de purge com segurança. Uso: PURGE_SERVO POS=OPEN ou POS=CLOSE. Sem parâmetros mostra status e configurações.
variable_min_z_height: 19.0    # Altura MÍNIMA necessária para abrir o servo (em mm)
variable_open_angle: 6        # Ângulo para posição aberta
variable_closed_angle: 115       # Ângulo para posição fechada
variable_last_position: "UNKNOWN"  # Última posição conhecida do servo (volátil)
gcode:
    # Obtém as variáveis configuradas
    {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
    {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
    {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
    {% set last_pos = printer["gcode_macro PURGE_SERVO"].last_position %}
    
    # Se não foi passado parâmetro POS, mostra status e configurações
    {% if not params.POS %}
        RESPOND MSG="PURGE_SERVO: === STATUS PURGE SERVO ==="
        {% if last_pos == "OPEN" %}
            RESPOND MSG="PURGE_SERVO: • Posição atual: ABERTO (ângulo: {open_angle}°)"
        {% elif last_pos == "CLOSED" %}
            RESPOND MSG="PURGE_SERVO: • Posição atual: FECHADO (ângulo: {closed_angle}°)"
        {% else %}
            RESPOND MSG="PURGE_SERVO: • Posição atual: Desconhecida (servo não foi usado nesta sessão)"
        {% endif %}
        RESPOND MSG="PURGE_SERVO: • Ângulo aberto: {open_angle}°"
        RESPOND MSG="PURGE_SERVO: • Ângulo fechado: {closed_angle}°"
        {% set min_z_str = "%.1f"|format(min_z) %}
        RESPOND MSG="PURGE_SERVO: • Altura mínima para abrir: {min_z_str}mm"
        {% if 'xyz' in printer.toolhead.homed_axes %}
            {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
            RESPOND MSG="PURGE_SERVO: • Altura atual da mesa: {current_z}mm"
            {% if printer.toolhead.position.z >= min_z %}
                RESPOND MSG="PURGE_SERVO: • Status: Mesa na altura segura para abertura"
            {% else %}
                RESPOND MSG="PURGE_SERVO: • Status: Mesa muito baixa para abertura"
            {% endif %}
        {% else %}
            RESPOND MSG="PURGE_SERVO: • Altura atual da mesa: Eixos não homeados"
            RESPOND MSG="PURGE_SERVO: • Status: Eixos precisam ser homeados"
        {% endif %}
        RESPOND MSG="PURGE_SERVO: === USO: PURGE_SERVO POS=OPEN ou POS=CLOSE ==="
    {% else %}
        {% set position = params.POS|upper %}
        {% if position == 'OPEN' %}
            # Verifica se os eixos estão homeados
            {% if not 'xyz' in printer.toolhead.homed_axes %}
                RESPOND MSG="PURGE_SERVO: ERRO: Eixos não estão homeados! Execute G28 antes de abrir o servo."
            # Verifica se a mesa está na altura mínima
            {% elif printer.toolhead.position.z < min_z %}
                {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
                {% set min_z_str = "%.1f"|format(min_z) %}
                RESPOND MSG="PURGE_SERVO: ERRO: Mesa muito baixa! Altura atual: {current_z}mm. Altura mínima necessária: {min_z_str}mm"
            # Tudo OK, pode abrir
            {% else %}
                {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
                SET_SERVO SERVO=purge_servo ANGLE={open_angle}
                SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=last_position VALUE='"OPEN"'
                RESPOND MSG="PURGE_SERVO: Servo purge ABERTO - Altura: {current_z}mm (ângulo: {open_angle}°)"
            {% endif %}
        {% elif position == 'CLOSE' %}
            SET_SERVO SERVO=purge_servo ANGLE={closed_angle}
            SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=last_position VALUE='"CLOSED"'
            RESPOND MSG="PURGE_SERVO: Servo purge FECHADO (ângulo: {closed_angle}°)"
        {% else %}
            RESPOND MSG="PURGE_SERVO: ERRO: Posição inválida! Use: POS=OPEN ou POS=CLOSE"
        {% endif %}
    {% endif %}


# Macros simplificadas para uso rápido
[gcode_macro PURGE_SERVO_OPEN]
description: Abre o servo de purge (com verificações de segurança)
gcode:
    PURGE_SERVO POS=OPEN

[gcode_macro PURGE_SERVO_CLOSE]
description: Fecha o servo de purge
gcode:
    PURGE_SERVO POS=CLOSE

# Macro para alterar configurações sem reiniciar
[gcode_macro SET_PURGE_SERVO_CONFIG]
description: Configura parâmetros do servo purge
gcode:
    {% if params.MIN_Z %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=min_z_height VALUE={params.MIN_Z|float}
        RESPOND MSG="PURGE_SERVO: Altura mínima alterada para: {params.MIN_Z}mm"
    {% endif %}
    
    {% if params.OPEN_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=open_angle VALUE={params.OPEN_ANGLE|int}
        RESPOND MSG="PURGE_SERVO: Ângulo de abertura alterado para: {params.OPEN_ANGLE}°"
    {% endif %}
    
    {% if params.CLOSED_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=closed_angle VALUE={params.CLOSED_ANGLE|int}
        RESPOND MSG="PURGE_SERVO: Ângulo de fechamento alterado para: {params.CLOSED_ANGLE}°"
    {% endif %}
    
    {% if not params.MIN_Z and not params.OPEN_ANGLE and not params.CLOSED_ANGLE %}
        {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
        {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
        {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
        RESPOND MSG="PURGE_SERVO: Configuração atual: MIN_Z={min_z}mm, OPEN_ANGLE={open_angle}°, CLOSED_ANGLE={closed_angle}°"
    {% endif %}
#‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù       ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù    


[gcode_macro SAVE_LAST_TOOL_INFO]
description: Salva cor e material da √∫ltima ferramenta utilizada
gcode:
    {% set last_tool = printer.mmu.last_tool|int %}
    {% set last_color = printer.mmu.gate_color[last_tool] %}
    {% set last_material = printer.mmu.gate_material[last_tool] %}
    {% set filament_remaining = printer.mmu.extruder_filament_remaining %}

    # Salva as informa√ß√µes em vari√°veis permanentes
    SAVE_VARIABLE VARIABLE=last_tool_number VALUE={last_tool}
    SAVE_VARIABLE VARIABLE=last_tool_color VALUE='"{last_color}"'
    SAVE_VARIABLE VARIABLE=last_tool_material VALUE='"{last_material}"'
    SAVE_VARIABLE VARIABLE=last_tool_filament_remaining VALUE='"{filament_remaining}"'
    
    # Feedback
    {action_respond_info("Informa√ß√µes da ferramenta %d salvas:" % (last_tool))}
    {action_respond_info("  Cor: %s" % (last_color))}
    {action_respond_info("  Material: %s" % (last_material))}

[gcode_macro SAVE_ACTIVE_TOOL_INFO]
description: Salva cor e material da √∫ltima ferramenta utilizada
gcode:

    {% set last_color = printer.mmu.active_filament.color %}
    {% set last_material = printer.mmu.active_filament.material %}


    # Salva as informa√ß√µes em vari√°veis permanentes
    SAVE_VARIABLE VARIABLE=last_tool_color VALUE='"{last_color}"'
    SAVE_VARIABLE VARIABLE=last_tool_material VALUE='"{last_material}"'

    
    # Feedback
    {action_respond_info("  Cor: %s" % (last_color))}
    {action_respond_info("  Material: %s" % (last_material))}

#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
#‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[gcode_macro PURGA_MMU]
# ==========================================================
# MACRO: PURGA_MMU - VERS√ÉO COM PONTOS + RASPADOR
# ==========================================================
description: >
  Purga mec√¢nica com servo/escova integrada, padr√£o de pontos com raspador, wipe diagonal e op√ß√£o de retra√ß√£o.
  Verifica√ß√£o inteligente de cor na primeira purga para evitar desperd√≠cio.
  Velocidades de purga ajustadas automaticamente por material.
  Detec√ß√£o de troca de material com volume fixo para limpeza completa do bico.
  Purga realizada em pontos estacion√°rios distribu√≠dos no eixo X central da bandeja.
  Ap√≥s cada ponto, movimento r√°pido em X para o raspador quebrar o filamento.
  Limpeza diagonal cruzada na escova retangular.
  Divis√£o autom√°tica de purgas grandes em 2 ciclos para esvaziar bandeja.
  Controle de ventilador durante a purga para resfriamento.
  
  PAR√ÇMETROS:
  ‚Ä¢ VOLUME=<valor>    ‚Üí Volume de filamento a purgar em mm¬≥
  ‚Ä¢ TESTE=<0|1|2>     ‚Üí Modo: 0=purga normal (extrus√£o+servo), 1=s√≥ movimentos, 2=movimentos+servo
  ‚Ä¢ DEBUG=<0|1>       ‚Üí Imprime c√°lculos e posi√ß√µes no console (0=off, 1=on)
  ‚Ä¢ RETRACT=<valor>   ‚Üí Retra√ß√£o em mm ap√≥s purga (0=sem retra√ß√£o)
  ‚Ä¢ ONLY_CLEAN=<0|1>  ‚Üí Apenas limpeza na escova (sem purga/retra√ß√£o, 0=off, 1=on)
gcode:
    RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW descarregado antes da purga"
    SET_SKEW CLEAR=1
    
    # Par√¢metros de entrada
    {% set manual_volume = params.VOLUME|default(0)|float %}
    {% set teste_mode = params.TESTE|default(0)|int %}
    {% set debug = params.DEBUG|default(0)|int %}
    {% set manual_retract = params.RETRACT|default(-1)|float %}
    {% set only_clean = params.ONLY_CLEAN|default(0)|int %}
    
    # ===== CONFIGURA√á√ïES DA MACRO =====
    # Posicionamento da bandeja de purga (movimento retangular)
    {% set tray_x1 = 115 %}               # Coordenada X do canto 1 (inferior esquerdo)
    {% set tray_y1 = 325 %}               # Coordenada Y do canto 1 (inferior esquerdo)

    {% set tray_x2 = 137 %}               # Coordenada X do canto 2 (inferior direito)
    {% set tray_y2 = 325 %}               # Coordenada Y do canto 2 (inferior direito)

    {% set tray_x3 = 137 %}               # Coordenada X do canto 3 (superior direito)
    {% set tray_y3 = 340 %}               # Coordenada Y do canto 3 (superior direito)

    {% set tray_x4 = 115 %}               # Coordenada X do canto 4 (superior esquerdo)
    {% set tray_y4 = 340 %}               # Coordenada Y do canto 4 (superior esquerdo)

    {% set purge_z = 20 %}                # Altura Z segura para movimentos de purga

    # --- COORDENADAS DA ESCOVA RETANGULAR ---
    {% set brush_x1 = 110 %}  # Canto inferior esquerdo X
    {% set brush_y1 = 317 %}  # Canto inferior esquerdo Y

    {% set brush_x2 = 145 %}  # Canto inferior direito X
    {% set brush_y2 = 317 %}  # Canto inferior direito Y

    {% set brush_x3 = 145 %}  # Canto superior direito X
    {% set brush_y3 = 326 %}  # Canto superior direito Y
    
    {% set brush_x4 = 110 %}  # Canto superior esquerdo X
    {% set brush_y4 = 326 %}  # Canto superior esquerdo Y
    
    # Controle de volume e divis√£o de purga
    {% set max_volume_per_cycle = 500 %}  # Volume m√°ximo (mm¬≥) antes de dividir em 2 ciclos
    {% set filament_diameter = 1.75 %}    # Di√¢metro do filamento em mm
    
    # --- CONFIGURA√á√ïES DOS PONTOS DE PURGA ---
    {% set purge_points = 5 %}            # N√∫mero de pontos de purga no centro
    {% set scraper_x = 150 %}             # Posi√ß√£o X do raspador (fora da bandeja)
    {% set break_speed = 12000 %}         # Velocidade do movimento de quebra (mm/min)
    
    # Controle do ventilador durante purga
    {% set fan_speed = 255 %}             # Velocidade do fan (0-255). Se 0, n√£o ativa o fan
    
    # Retra√ß√£o e limpeza
    {% set default_retract = 12 %}        # Retra√ß√£o padr√£o em mm ap√≥s purga
    {% set brush_strokes = 3 %}           # N√∫mero de passadas diagonais na escova
    {% set wipe_offset = 10 %}            # Dist√¢ncia em mm para sa√≠da lateral da escova
    
    # Posi√ß√£o segura (para n√£o interferir no fechamento da bandeja)
    {% set safe_x = 245 %}                # Coordenada X da posi√ß√£o segura
    {% set safe_y = 300 %}                # Coordenada Y da posi√ß√£o segura
    
    # Volumes de purga inteligentes
    {% set first_purge_volume = 450 %}    # Volume (mm¬≥) para primeira purga (cor diferente)
    {% set same_color_margin = 2 %}       # Multiplicador para purga de mesma cor
    {% set material_change_purge_volume = 850 %}  # Volume (mm¬≥) fixo para troca de material
    {% set default_purge_volume = 100 %}  # Volume (mm¬≥) padr√£o quando toolchange_purge_volume = 0
    

    
    # ===== VELOCIDADES DE PURGA POR MATERIAL =====
    {% set purge_speed_abs = 400 %}       # Velocidade de extrus√£o para ABS (mm/min)
    {% set purge_speed_tpu = 150 %}       # Velocidade de extrus√£o para TPU (mm/min)
    {% set purge_speed_pla = 400 %}       # Velocidade de extrus√£o para PLA (mm/min)
    {% set purge_speed_hips = 400 %}      # Velocidade de extrus√£o para HIPS (mm/min)
    {% set purge_speed_petg = 350 %}      # Velocidade de extrus√£o para PETG (mm/min)
    {% set purge_speed_default = 400 %}   # Velocidade de extrus√£o padr√£o (mm/min)
    
    # ==========================================================
    # MODO ONLY_CLEAN: APENAS LIMPEZA (SEM PURGA/RETRA√á√ÉO)
    # ==========================================================
    {% if only_clean %}
        RESPOND TYPE=command MSG="PURGA_MMU: *** MODO ONLY_CLEAN *** Apenas limpeza na escova"
        
        SAVE_GCODE_STATE NAME=PURGA_MMU_STATE
        
        # Garantir altura segura
        {% set current_z = printer.toolhead.position.z %}
        {% if current_z < purge_z %}
            G90
            G1 Z{purge_z} F3000
        {% endif %}
        
        # --- ATIVA VENTILADOR (se configurado) ---
        {% if fan_speed > 0 %}
            M106 S{fan_speed}
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador ativado - Velocidade: {fan_speed}/255"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador desativado (fan_speed=0)"
        {% endif %}
        
        # --- ABRE BANDEJA ---
        {% if teste_mode != 1 %}
            PURGE_SERVO_OPEN
            G4 P500
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Bandeja aberta" {% endif %}
        {% endif %}
        
        # --- LIMPEZA NA ESCOVA (MOVIMENTOS DIAGONAIS CRUZADOS) ---
        RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Iniciando limpeza diagonal na escova"
        
        # Movimento inicial para o primeiro canto (inferior esquerdo)
        G90
        G1 X{brush_x1} Y{brush_y1} F6000
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Posi√ß√£o inicial - Canto 1: X{brush_x1} Y{brush_y1}" {% endif %}
        
        # Zigue-zague diagonal cruzado
        {% for i in range(brush_strokes|int) %}
            {% if i % 2 == 0 %}
                # Diagonal ascendente: Canto 1 ‚Üí Canto 3 (esquerda-baixo ‚Üí direita-cima)
                G1 X{brush_x3} Y{brush_y3} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/A - Diagonal ‚Üó (C1‚ÜíC3)" {% endif %}
                # Move para Canto 2 (inferior direito)
                G1 X{brush_x2} Y{brush_y2} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/B - Move para C2" {% endif %}
                # Diagonal ascendente: Canto 2 ‚Üí Canto 4 (direita-baixo ‚Üí esquerda-cima)
                G1 X{brush_x4} Y{brush_y4} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/C - Diagonal ‚Üñ (C2‚ÜíC4)" {% endif %}
                # Retorna para Canto 1
                G1 X{brush_x1} Y{brush_y1} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/D - Retorna C1" {% endif %}
            {% else %}
                # Diagonal descendente: Canto 4 ‚Üí Canto 2 (esquerda-cima ‚Üí direita-baixo)
                G1 X{brush_x4} Y{brush_y4} F3000
                G1 X{brush_x2} Y{brush_y2} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/A - Diagonal ‚Üò (C4‚ÜíC2)" {% endif %}
                # Move para Canto 3 (superior direito)
                G1 X{brush_x3} Y{brush_y3} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/B - Move para C3" {% endif %}
                # Diagonal descendente: Canto 3 ‚Üí Canto 1 (direita-cima ‚Üí esquerda-baixo)
                G1 X{brush_x1} Y{brush_y1} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN Stroke {i+1}/C - Diagonal ‚Üô (C3‚ÜíC1)" {% endif %}
            {% endif %}
        {% endfor %}
        
        # --- WIPE FINAL ---
        # Sai pela direita da escova (lateral, n√£o para cima)
        {% set exit_x = brush_x3 + wipe_offset %}
        {% set exit_y = (brush_y3 + brush_y2) / 2 %}
        G90
        G1 X{exit_x} Y{exit_y} F3000
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Sa√≠da lateral - X{exit_x|round(1)} Y{exit_y|round(1)}" {% endif %}
        
        # --- SAFE POSITION (necess√°rio antes de fechar bandeja) ---
        G1 X{safe_x} Y{safe_y} F7800
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Posi√ß√£o segura alcan√ßada" {% endif %}
        
        # --- DESATIVA VENTILADOR ---
        {% if fan_speed > 0 %}
            M107
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador desativado"
        {% endif %}
        
        # --- RECOLHE BANDEJA ---
        {% if teste_mode != 1 %}
            PURGE_SERVO_CLOSE
            G4 P500
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: ONLY_CLEAN - Bandeja fechada" {% endif %}
        {% endif %}
        
        RESTORE_GCODE_STATE NAME=PURGA_MMU_STATE
        RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW carregado ap√≥s a limpeza"
        SKEW_PROFILE LOAD=skew_profile
        
        RESPOND TYPE=command MSG="PURGA_MMU: ‚úì ONLY_CLEAN conclu√≠do - Limpeza finalizada"
        
    {% else %}
        # ==========================================================
        # MODO NORMAL: PURGA COMPLETA COM LIMPEZA
        # ==========================================================
        
        # ===== DETEC√á√ÉO DE MATERIAL E VELOCIDADE =====
        {% set active_material = printer.mmu.active_filament.material|default("")|string|upper %}
        
        {% if active_material == "TPU" %}
            {% set purge_feed = purge_speed_tpu %}
        {% elif active_material == "ABS" %}
            {% set purge_feed = purge_speed_abs %}
        {% elif active_material == "PLA" %}
            {% set purge_feed = purge_speed_pla %}
        {% elif active_material == "HIPS" %}
            {% set purge_feed = purge_speed_hips %}
        {% elif active_material == "PETG" %}
            {% set purge_feed = purge_speed_petg %}
        {% else %}
            {% set purge_feed = purge_speed_default %}
        {% endif %}
        
        {% if active_material != "" %}
            RESPOND TYPE=command MSG="PURGA_MMU: Material detectado: {active_material} | Velocidade: {purge_feed} mm/min"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Material n√£o detectado, usando velocidade padr√£o: {purge_feed} mm/min"
        {% endif %}
        
        # ===== CONFIGURA√á√ÉO DA RETRA√á√ÉO =====
        {% set retract_after_purge = manual_retract if manual_retract >= 0 else default_retract %}
        
        # Mensagem sobre retra√ß√£o configurada
        {% if teste_mode == 0 %}
            {% if retract_after_purge > 0 %}
                RESPOND TYPE=command MSG="PURGA_MMU: Retra√ß√£o configurada: {retract_after_purge} mm"
            {% else %}
                RESPOND TYPE=command MSG="PURGA_MMU: ATEN√á√ÉO - Retra√ß√£o desabilitada (RETRACT=0)"
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Modo teste {teste_mode} - Retra√ß√£o n√£o ser√° executada"
        {% endif %}
        
        # Obter n√∫mero de trocas de ferramenta
        {% set num_toolchanges = printer.mmu.num_toolchanges|default(0)|int %}
        
        # ===== DETEC√á√ÉO DE TROCA DE MATERIAL =====
        {% set material_changed = false %}
        {% set last_material = "" %}
        
        {% if num_toolchanges == 0 %}
            # PRIMEIRA TROCA: usar save_variables
            {% set last_material = printer.save_variables.variables.last_tool_material|default("")|string|upper %}
            
            {% if last_material != "" and active_material != "" and last_material != active_material %}
                {% set material_changed = true %}
            {% endif %}
            
            {% if debug %}
                RESPOND TYPE=command MSG="PURGA_MMU: [PRIMEIRA TROCA] Material anterior (save_variables): '{last_material}'"
                RESPOND TYPE=command MSG="PURGA_MMU: [PRIMEIRA TROCA] Material atual: '{active_material}' | Troca: {material_changed}"
            {% endif %}
        {% else %}
            # DEMAIS TROCAS: usar printer.mmu.last_tool e printer.mmu.gate_material
            {% set last_tool = printer.mmu.last_tool|default(-1)|int %}
            
            {% if last_tool >= 0 %}
                {% set last_material = printer.mmu.gate_material[last_tool]|default("")|string|upper %}
                
                {% if last_material != "" and active_material != "" and last_material != active_material %}
                    {% set material_changed = true %}
                {% endif %}
                
                {% if debug %}
                    RESPOND TYPE=command MSG="PURGA_MMU: [DEMAIS TROCAS] Last tool: T{last_tool}"
                    RESPOND TYPE=command MSG="PURGA_MMU: [DEMAIS TROCAS] Material anterior (gate_material[{last_tool}]): '{last_material}'"
                    RESPOND TYPE=command MSG="PURGA_MMU: [DEMAIS TROCAS] Material atual: '{active_material}' | Troca: {material_changed}"
                {% endif %}
            {% else %}
                {% if debug %}
                    RESPOND TYPE=command MSG="PURGA_MMU: [DEMAIS TROCAS] Last tool inv√°lido ({last_tool}), sem detec√ß√£o de troca"
                {% endif %}
            {% endif %}
        {% endif %}
        
        # ===== L√ìGICA DE DETERMINA√á√ÉO DO VOLUME DE PURGA =====
        {% if manual_volume > 0 %}
            {% set purge_volume = manual_volume %}
            {% set volume_source = "manual" %}
            
        {% elif material_changed %}
            {% set purge_volume = material_change_purge_volume %}
            {% set volume_source = "troca_material" %}
            
            RESPOND TYPE=command MSG="PURGA_MMU: *** TROCA DE MATERIAL DETECTADA ***"
            RESPOND TYPE=command MSG="PURGA_MMU: {last_material} ‚Üí {active_material}"
            RESPOND TYPE=command MSG="PURGA_MMU: Volume fixo para limpeza: {purge_volume|round(1)}mm¬≥"
            RESPOND TYPE=command MSG="PURGA_MMU: (Ignorando mapa de purga e verifica√ß√£o de cor)"
            
        {% elif num_toolchanges == 0 %}
            # PRIMEIRA PURGA - VERIFICAR CORES
            {% set last_color = printer.save_variables.variables.last_tool_color|default("")|string %}
            {% set remaining_length = printer.save_variables.variables.last_tool_filament_remaining|default(0)|float %}
            {% set active_color = printer.mmu.active_filament.color|default("")|string %}
            
            {% if debug %}
                RESPOND TYPE=command MSG="PURGA_MMU: Cor anterior (save_variables): '{last_color}' | Comprimento restante: {remaining_length}mm"
                RESPOND TYPE=command MSG="PURGA_MMU: Cor atual (MMU): '{active_color}'"
            {% endif %}
            
            # Verificar se temos dados de cor v√°lidos (strings n√£o vazias)
            {% if last_color != "" and active_color != "" %}
                # Ambas as cores est√£o dispon√≠veis - comparar
                {% if last_color|lower == active_color|lower %}
                    # MESMA COR DETECTADA
                    {% if remaining_length > 0 %}
                        {% set optimized_length = remaining_length * same_color_margin %}
                        {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}
                        {% set purge_volume = optimized_length * filament_area %}
                        {% set volume_source = "mesma_cor_otimizada" %}
                        
                        RESPOND TYPE=command MSG="PURGA_MMU: *** MESMA COR DETECTADA *** Filamento restante: {remaining_length|round(1)}mm"
                        RESPOND TYPE=command MSG="PURGA_MMU: Cores: {last_color} = {active_color}"
                        RESPOND TYPE=command MSG="PURGA_MMU: Volume otimizado: {purge_volume|round(1)}mm¬≥"
                    {% else %}
                        {% set purge_volume = first_purge_volume %}
                        {% set volume_source = "primeira_purga_fallback" %}
                        RESPOND TYPE=command MSG="PURGA_MMU: Mesma cor detectada, mas sem dados de comprimento v√°lidos. Usando volume padr√£o."
                    {% endif %}
                {% else %}
                    # CORES DIFERENTES
                    {% set purge_volume = first_purge_volume %}
                    {% set volume_source = "primeira_purga_cor_diferente" %}
                    
                    RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Cores diferentes detectadas:"
                    RESPOND TYPE=command MSG="PURGA_MMU: Anterior: {last_color} ‚â† Atual: {active_color}"
                    RESPOND TYPE=command MSG="PURGA_MMU: Volume padr√£o: {purge_volume|round(1)}mm¬≥"
                {% endif %}
            {% else %}
                # DADOS DE COR INDISPON√çVEIS
                {% set purge_volume = first_purge_volume %}
                {% set volume_source = "primeira_purga_sem_dados" %}
                
                RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Dados de cor indispon√≠veis. Volume padr√£o: {purge_volume|round(1)}mm¬≥"
                {% if last_color == "" %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚Üí Cor anterior n√£o dispon√≠vel no save_variables"
                {% endif %}
                {% if active_color == "" %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚Üí Cor atual n√£o dispon√≠vel no MMU"
                {% endif %}
            {% endif %}
        {% else %}
            {% set purge_vol_from_mmu = printer.mmu.toolchange_purge_volume|default(0)|float %}
            {% if purge_vol_from_mmu > 0 %}
                {% set purge_volume = purge_vol_from_mmu %}
                {% set volume_source = "normal" %}
            {% else %}
                {% set purge_volume = default_purge_volume %}
                {% set volume_source = "default_fallback" %}
                RESPOND TYPE=command MSG="PURGA_MMU: ‚ö†Ô∏è toolchange_purge_volume = 0, usando volume padr√£o: {default_purge_volume}mm¬≥"
            {% endif %}
        {% endif %}

        # ===== VERIFICA√á√ÉO DE DIVIS√ÉO DE PURGA =====
        {% set needs_split = purge_volume > max_volume_per_cycle %}
        {% set num_purge_cycles = 2 if needs_split else 1 %}
        {% set volume_per_cycle = (purge_volume / 2) if needs_split else purge_volume %}
        
        {% if needs_split %}
            RESPOND TYPE=command MSG="PURGA_MMU: ‚ö†Ô∏è Volume grande detectado ({purge_volume|round(1)}mm¬≥ > {max_volume_per_cycle}mm¬≥)"
            RESPOND TYPE=command MSG="PURGA_MMU: üîÑ Dividindo em 2 ciclos completos de {volume_per_cycle|round(1)}mm¬≥ cada"
        {% endif %}

        {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}

        {% if num_toolchanges == 0 %}
            RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** - Trocas: {num_toolchanges} | Volume total: {purge_volume|round(1)} mm¬≥ | Fonte: {volume_source}"
        {% endif %}

        RESPOND TYPE=command MSG="PURGA_MMU: Purga: {purge_volume|round(1)} mm¬≥ total | Ciclos: {num_purge_cycles} | TESTE={teste_mode} | DEBUG={debug} | Fonte: {volume_source}"
        
        # Calcular centro Y da bandeja e espa√ßamento dos pontos
        {% set center_y = (tray_y1 + tray_y3) / 2 %}
        {% set point_spacing = (tray_x2 - tray_x1) / (purge_points - 1) if purge_points > 1 else 0 %}
        
        {% if debug %}
          RESPOND TYPE=command MSG="PURGA_MMU: Trocas de ferramenta: {num_toolchanges}"
          RESPOND TYPE=command MSG="PURGA_MMU: Material ativo: {active_material}"
          RESPOND TYPE=command MSG="PURGA_MMU: Velocidade de purga: {purge_feed} mm/min"
          RESPOND TYPE=command MSG="PURGA_MMU: Velocidade do ventilador: {fan_speed}/255"
          RESPOND TYPE=command MSG="PURGA_MMU: Bandeja: C1({tray_x1},{tray_y1}) C2({tray_x2},{tray_y2}) C3({tray_x3},{tray_y3}) C4({tray_x4},{tray_y4})"
          RESPOND TYPE=command MSG="PURGA_MMU: √Årea escova: C1({brush_x1},{brush_y1}) C2({brush_x2},{brush_y2}) C3({brush_x3},{brush_y3}) C4({brush_x4},{brush_y4})"
          RESPOND TYPE=command MSG="PURGA_MMU: Pontos de purga: {purge_points} pontos em Y={center_y|round(1)}, espa√ßamento X: {point_spacing|round(2)}mm"
          RESPOND TYPE=command MSG="PURGA_MMU: Raspador em X={scraper_x} | Velocidade quebra: {break_speed}mm/min"
          RESPOND TYPE=command MSG="PURGA_MMU: Passadas de limpeza diagonal: {brush_strokes}"
          RESPOND TYPE=command MSG="PURGA_MMU: Retra√ß√£o ap√≥s purga: {retract_after_purge} mm"
          RESPOND TYPE=command MSG="PURGA_MMU: Necessita divis√£o: {needs_split} | Ciclos principais: {num_purge_cycles}"
        {% endif %}

        SAVE_GCODE_STATE NAME=PURGA_MMU_STATE

        {% set current_z = printer.toolhead.position.z %}
        {% if current_z < purge_z %}
          G90
          G1 Z{purge_z} F3000
        {% endif %}

        # --- ATIVA VENTILADOR (se configurado) ---
        {% if fan_speed > 0 %}
            M106 S{fan_speed}
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador ativado - Velocidade: {fan_speed}/255"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador desativado (fan_speed=0)"
        {% endif %}

        # ==========================================================
        # IN√çCIO DOS CICLOS DE PURGA
        # ==========================================================
        {% for main_cycle in range(num_purge_cycles) %}
            {% set cycle_num = main_cycle + 1 %}
            {% set purge_length = volume_per_cycle / filament_area %}
            
            {% if num_purge_cycles > 1 %}
                RESPOND TYPE=command MSG="PURGA_MMU: ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                RESPOND TYPE=command MSG="PURGA_MMU: üîÑ CICLO {cycle_num}/2 - Volume: {volume_per_cycle|round(1)}mm¬≥ ({purge_length|round(1)}mm)"
                RESPOND TYPE=command MSG="PURGA_MMU: ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            {% endif %}

            # --- ABRE BANDEJA ---
            {% if teste_mode != 1 %}
              PURGE_SERVO_OPEN
              G4 P500
              {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Bandeja aberta" {% endif %}
            {% endif %}

            # --- PURGA NA BANDEJA (PONTOS + RASPADOR) ---
            G90  # Modo absoluto para XY
            M83  # Modo relativo para extrus√£o
            MMU_SYNC_GEAR_MOTOR SYNC=1

            {% if teste_mode == 0 %}
              # ===== PURGA COM PONTOS ESTACION√ÅRIOS + MOVIMENTO PARA RASPADOR =====
              
              # Calcular extrus√£o por ponto
              {% set length_per_point = purge_length / purge_points %}
              
              {% if debug %}
                RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Purga total: {purge_length|round(2)}mm em {purge_points} pontos"
                RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Extrus√£o por ponto: {length_per_point|round(2)}mm"
                RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Pontos em Y={center_y|round(1)}, espa√ßamento X: {point_spacing|round(2)}mm"
                RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Raspador em X={scraper_x}, velocidade: {break_speed}mm/min"
              {% endif %}
              
              RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Iniciando {purge_points} pontos de purga"
              
              {% for p in range(purge_points|int) %}
                # Calcular posi√ß√£o X do ponto atual (esquerda para direita)
                {% set point_x = tray_x1 + (p * point_spacing) %}
                
                # Mover para o ponto de purga
                G1 X{point_x} Y{center_y} F7800
                
                {% if debug %}
                  RESPOND TYPE=command MSG="PURGA_MMU: Ponto {p+1}/{purge_points} - Posi√ß√£o X{point_x|round(1)} Y{center_y|round(1)}"
                {% endif %}
                
                # Purgar no ponto estacion√°rio
                G1 E{length_per_point|round(4)} F{purge_feed}
                
                # Pequena pausa para formar a "bola"
                G4 P150
                
                # Movimento r√°pido para o raspador (quebra o filamento)
                G1 X{scraper_x} F{break_speed}
                
                {% if debug %}
                  RESPOND TYPE=command MSG="PURGA_MMU: Ponto {p+1}/{purge_points} - Raspador acionado em X{scraper_x}"
                {% endif %}
                
                G4 P100  # Pequena pausa ap√≥s quebra
              {% endfor %}
              
              RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Purga conclu√≠da ({purge_points} bolas)"
              
              # ===== RETRA√á√ÉO AP√ìS PURGA =====
              {% if retract_after_purge|float > 0 %}
                RESPOND TYPE=command MSG="PURGA_MMU: >>> Ciclo {cycle_num} - Executando retra√ß√£o de {retract_after_purge} mm <<<"
                G1 E-{retract_after_purge|float} F2400
                G4 P100  # Pequena pausa para garantir execu√ß√£o
                RESPOND TYPE=command MSG="PURGA_MMU: >>> Ciclo {cycle_num} - Retra√ß√£o conclu√≠da <<<"
              {% else %}
                RESPOND TYPE=command MSG="PURGA_MMU: >>> ATEN√á√ÉO: Retra√ß√£o pulada (valor: {retract_after_purge}) <<<"
              {% endif %}
              
            {% else %}
              # Modo teste - movimento sem extrus√£o
              RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Modo teste {teste_mode} - Pontos + raspador sem extrus√£o"
              
              {% for p in range(purge_points|int) %}
                {% set point_x = tray_x1 + (p * point_spacing) %}
                
                # Mover para o ponto
                G1 X{point_x} Y{center_y} F7800
                RESPOND TYPE=command MSG="PURGA_MMU: Teste ponto {p+1}/{purge_points} - X{point_x|round(1)} Y{center_y|round(1)}"
                
                G4 P300  # Simula tempo de purga
                
                # Movimento para raspador
                G1 X{scraper_x} F{break_speed}
                RESPOND TYPE=command MSG="PURGA_MMU: Teste ponto {p+1}/{purge_points} - Raspador X{scraper_x}"
                
                G4 P100
              {% endfor %}
            {% endif %}

            # --- LIMPEZA NA ESCOVA (MOVIMENTOS DIAGONAIS CRUZADOS) ---
            RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Iniciando limpeza diagonal na escova"
            
            # Movimento inicial para o primeiro canto (inferior esquerdo)
            G90
            G1 X{brush_x1} Y{brush_y1} F6000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Posi√ß√£o inicial - Canto 1: X{brush_x1} Y{brush_y1}" {% endif %}
            
            # Zigue-zague diagonal cruzado
            {% for i in range(brush_strokes|int) %}
                {% if i % 2 == 0 %}
                    # Diagonal ascendente: Canto 1 ‚Üí Canto 3 (esquerda-baixo ‚Üí direita-cima)
                    G1 X{brush_x3} Y{brush_y3} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/A - Diagonal ‚Üó (C1‚ÜíC3)" {% endif %}
                    # Move para Canto 2 (inferior direito)
                    G1 X{brush_x2} Y{brush_y2} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/B - Move para C2" {% endif %}
                    # Diagonal ascendente: Canto 2 ‚Üí Canto 4 (direita-baixo ‚Üí esquerda-cima)
                    G1 X{brush_x4} Y{brush_y4} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/C - Diagonal ‚Üñ (C2‚ÜíC4)" {% endif %}
                    # Retorna para Canto 1
                    G1 X{brush_x1} Y{brush_y1} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/D - Retorna C1" {% endif %}
                {% else %}
                    # Diagonal descendente: Canto 4 ‚Üí Canto 2 (esquerda-cima ‚Üí direita-baixo)
                    G1 X{brush_x4} Y{brush_y4} F3000
                    G1 X{brush_x2} Y{brush_y2} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/A - Diagonal ‚Üò (C4‚ÜíC2)" {% endif %}
                    # Move para Canto 3 (superior direito)
                    G1 X{brush_x3} Y{brush_y3} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/B - Move para C3" {% endif %}
                    # Diagonal descendente: Canto 3 ‚Üí Canto 1 (direita-cima ‚Üí esquerda-baixo)
                    G1 X{brush_x1} Y{brush_y1} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/C - Diagonal ‚Üô (C3‚ÜíC1)" {% endif %}
                {% endif %}
            {% endfor %}

            # --- WIPE FINAL ---
            # Sai pela direita da escova (lateral, n√£o para cima)
            {% set exit_x = brush_x3 + wipe_offset %}
            {% set exit_y = (brush_y3 + brush_y2) / 2 %}
            G90
            G1 X{exit_x} Y{exit_y} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Sa√≠da lateral - X{exit_x|round(1)} Y{exit_y|round(1)}" {% endif %}

            # --- SAFE POSITION (necess√°rio antes de fechar bandeja) ---
            G1 X{safe_x} Y{safe_y} F7800
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Posi√ß√£o segura alcan√ßada" {% endif %}

            # --- RECOLHE BANDEJA (esvazia o balde) ---
            {% if teste_mode != 1 %}
              PURGE_SERVO_CLOSE
              G4 P500
              {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Bandeja fechada (balde esvaziado)" {% endif %}
            {% endif %}
            
            {% if num_purge_cycles > 1 %}
                RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Ciclo {cycle_num}/2 conclu√≠do"
                {% if cycle_num < num_purge_cycles %}
                    G4 P1000  # Pausa entre ciclos para garantir estabilidade
                {% endif %}
            {% endif %}
        {% endfor %}
        # ==========================================================
        # FIM DOS CICLOS DE PURGA
        # ==========================================================

        # --- DESATIVA VENTILADOR ---
        {% if fan_speed > 0 %}
            M107
            RESPOND TYPE=command MSG="PURGA_MMU: Ventilador desativado"
        {% endif %}

        RESTORE_GCODE_STATE NAME=PURGA_MMU_STATE
        RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW carregado ap√≥s a purga"
        SKEW_PROFILE LOAD=skew_profile
        #Salva os dados do filamento atual
        SAVE_ACTIVE_TOOL_INFO
        
        # Mensagem final de confirma√ß√£o
        {% if teste_mode == 0 %}
            {% if retract_after_purge > 0 %}
                {% if num_purge_cycles > 1 %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì {num_purge_cycles} ciclos de purga e retra√ß√£o conclu√≠dos com sucesso"
                {% else %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Purga e retra√ß√£o conclu√≠das com sucesso"
                {% endif %}
            {% else %}
                {% if num_purge_cycles > 1 %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì {num_purge_cycles} ciclos de purga conclu√≠dos (sem retra√ß√£o)"
                {% else %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Purga conclu√≠da (sem retra√ß√£o)"
                {% endif %}
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Teste de movimentos conclu√≠do ({num_purge_cycles} ciclo(s))"
        {% endif %}
    {% endif %}



    
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
#‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù 
[gcode_macro PURGE_SERVO]
description: Controla servo de purge com seguran√ßa. Uso: PURGE_SERVO POS=OPEN ou POS=CLOSE. Sem par√¢metros mostra status e configura√ß√µes.
variable_min_z_height: 19.0    # Altura M√çNIMA necess√°ria para abrir o servo (em mm)
variable_open_angle: 6        # √Çngulo para posi√ß√£o aberta
variable_closed_angle: 115       # √Çngulo para posi√ß√£o fechada
variable_last_position: "UNKNOWN"  # √öltima posi√ß√£o conhecida do servo (vol√°til)
gcode:
    # Obt√©m as vari√°veis configuradas
    {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
    {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
    {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
    {% set last_pos = printer["gcode_macro PURGE_SERVO"].last_position %}
    
    # Se n√£o foi passado par√¢metro POS, mostra status e configura√ß√µes
    {% if not params.POS %}
        RESPOND TYPE=command MSG="PURGE_SERVO: === STATUS PURGE SERVO ==="
        {% if last_pos == "OPEN" %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Posi√ß√£o atual: ABERTO (√¢ngulo: {open_angle}¬∞)"
        {% elif last_pos == "CLOSED" %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Posi√ß√£o atual: FECHADO (√¢ngulo: {closed_angle}¬∞)"
        {% else %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Posi√ß√£o atual: Desconhecida (servo n√£o foi usado nesta sess√£o)"
        {% endif %}
        RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ √Çngulo aberto: {open_angle}¬∞"
        RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ √Çngulo fechado: {closed_angle}¬∞"
        {% set min_z_str = "%.1f"|format(min_z) %}
        RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Altura m√≠nima para abrir: {min_z_str}mm"
        {% if 'xyz' in printer.toolhead.homed_axes %}
            {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Altura atual da mesa: {current_z}mm"
            {% if printer.toolhead.position.z >= min_z %}
                RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Status: Mesa na altura segura para abertura"
            {% else %}
                RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Status: Mesa muito baixa para abertura"
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Altura atual da mesa: Eixos n√£o homeados"
            RESPOND TYPE=command MSG="PURGE_SERVO: ‚Ä¢ Status: Eixos precisam ser homeados"
        {% endif %}
        RESPOND TYPE=command MSG="PURGE_SERVO: === USO: PURGE_SERVO POS=OPEN ou POS=CLOSE ==="
    {% else %}
        {% set position = params.POS|upper %}
        {% if position == 'OPEN' %}
            # Verifica se os eixos est√£o homeados
            {% if not 'xyz' in printer.toolhead.homed_axes %}
                RESPOND TYPE=command MSG="PURGE_SERVO: ERRO: Eixos n√£o est√£o homeados! Execute G28 antes de abrir o servo."
            # Verifica se a mesa est√° na altura m√≠nima
            {% elif printer.toolhead.position.z < min_z %}
                {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
                {% set min_z_str = "%.1f"|format(min_z) %}
                RESPOND TYPE=command MSG="PURGE_SERVO: ERRO: Mesa muito baixa! Altura atual: {current_z}mm. Altura m√≠nima necess√°ria: {min_z_str}mm"
            # Tudo OK, pode abrir
            {% else %}
                {% set current_z = "%.1f"|format(printer.toolhead.position.z) %}
                SET_SERVO SERVO=purge_servo ANGLE={open_angle}
                SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=last_position VALUE='"OPEN"'
                RESPOND TYPE=command MSG="PURGE_SERVO: Servo purge ABERTO - Altura: {current_z}mm (√¢ngulo: {open_angle}¬∞)"
            {% endif %}
        {% elif position == 'CLOSE' %}
            SET_SERVO SERVO=purge_servo ANGLE={closed_angle}
            SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=last_position VALUE='"CLOSED"'
            RESPOND TYPE=command MSG="PURGE_SERVO: Servo purge FECHADO (√¢ngulo: {closed_angle}¬∞)"
        {% else %}
            RESPOND TYPE=command MSG="PURGE_SERVO: ERRO: Posi√ß√£o inv√°lida! Use: POS=OPEN ou POS=CLOSE"
        {% endif %}
    {% endif %}

# Macros simplificadas para uso r√°pido
[gcode_macro PURGE_SERVO_OPEN]
description: Abre o servo de purge (com verifica√ß√µes de seguran√ßa)
gcode:
    PURGE_SERVO POS=OPEN

[gcode_macro PURGE_SERVO_CLOSE]
description: Fecha o servo de purge
gcode:
    PURGE_SERVO POS=CLOSE

# Macro para alterar configura√ß√µes sem reiniciar
[gcode_macro SET_PURGE_SERVO_CONFIG]
description: Configura par√¢metros do servo purge
gcode:
    {% if params.MIN_Z %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=min_z_height VALUE={params.MIN_Z|float}
        RESPOND TYPE=command MSG="PURGE_SERVO: Altura m√≠nima alterada para: {params.MIN_Z}mm"
    {% endif %}
    
    {% if params.OPEN_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=open_angle VALUE={params.OPEN_ANGLE|int}
        RESPOND TYPE=command MSG="PURGE_SERVO: √Çngulo de abertura alterado para: {params.OPEN_ANGLE}¬∞"
    {% endif %}
    
    {% if params.CLOSED_ANGLE %}
        SET_GCODE_VARIABLE MACRO=PURGE_SERVO VARIABLE=closed_angle VALUE={params.CLOSED_ANGLE|int}
        RESPOND TYPE=command MSG="PURGE_SERVO: √Çngulo de fechamento alterado para: {params.CLOSED_ANGLE}¬∞"
    {% endif %}
    
    {% if not params.MIN_Z and not params.OPEN_ANGLE and not params.CLOSED_ANGLE %}
        {% set min_z = printer["gcode_macro PURGE_SERVO"].min_z_height %}
        {% set open_angle = printer["gcode_macro PURGE_SERVO"].open_angle %}
        {% set closed_angle = printer["gcode_macro PURGE_SERVO"].closed_angle %}
        RESPOND TYPE=command MSG="PURGE_SERVO: Configura√ß√£o atual: MIN_Z={min_z}mm, OPEN_ANGLE={open_angle}¬∞, CLOSED_ANGLE={closed_angle}¬∞"
    {% endif %}
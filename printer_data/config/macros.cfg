# ██████╗████████╗ █████╗ ██████╗ ████████╗  ██████╗ ██████╗ ██╗███╗  ██╗████████╗
#██╔════╝╚══██╔══╝██╔══██╗██╔══██╗╚══██╔══╝  ██╔══██╗██╔══██╗██║████╗ ██║╚══██╔══╝
#╚█████╗    ██║   ███████║██████╔╝   ██║     ██████╔╝██████╔╝██║██╔██╗██║   ██║   
# ╚═══██╗   ██║   ██╔══██║██╔══██╗   ██║     ██╔═══╝ ██╔══██╗██║██║╚████║   ██║   
#██████╔╝   ██║   ██║  ██║██║  ██║   ██║     ██║     ██║  ██║██║██║ ╚███║   ██║   
#╚═════╝    ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝     ╚═╝     ╚═╝  ╚═╝╚═╝╚═╝  ╚══╝   ╚═╝ 
[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    # Start bed heating
    M140 S{BED_TEMP}
    #Seta temperatura do extrusor e aguarda
    RESPOND MSG="Aguardando aquecimento do bico"
    M109 S{EXTRUDER_TEMP}
    
    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset
    SET_GCODE_OFFSET Z=0.0
    # Home the printer
    G28
    # Wait for bed to reach temperature
    M190 S{BED_TEMP}
    #Executa nivelamento da mesa 
    BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX}
    # Log inicial com o valor atual da variável
    RESPOND MSG=" START_PRINT: [MMU BYPASS CHECK] Verificando tool atual: {printer.mmu.tool}"
    {% if printer.mmu.tool == -1 or printer.mmu.tool == -2 %}
        # Tool é -1 ou -2, executa movimento direto
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Tool é {printer.mmu.tool} Usando porta de Bypass - Executando movimento direto G1 X0 Y2.50 Z0.78 F2400"
        G1 X0 Y2.50 Z0.78 F2400
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Movimento direto concluído"
        MMU_TEST_CONFIG enable_clog_detection=0
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Desativando detecão de obstrução"
    {% else %}
        # Tool não é -1 nem -2, executa macro PURGA_PREUNLOAD
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Tool é {printer.mmu.tool} - Impressão sem Bypass"
    {% endif %}
    
    RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Verificação de BYPASS  finalizada"
    RESPOND TYPE=command MSG="START_PRINT: Perfil SKEW carregado no início da impressão"
    SKEW_PROFILE LOAD=skew_profile
    GET_CURRENT_SKEW

   

#███████╗███╗  ██╗██████╗   ██████╗ ██████╗ ██╗███╗  ██╗████████╗
#██╔════╝████╗ ██║██╔══██╗  ██╔══██╗██╔══██╗██║████╗ ██║╚══██╔══╝
#█████╗  ██╔██╗██║██║  ██║  ██████╔╝██████╔╝██║██╔██╗██║   ██║   
#██╔══╝  ██║╚████║██║  ██║  ██╔═══╝ ██╔══██╗██║██║╚████║   ██║   
#███████╗██║ ╚███║██████╔╝  ██║     ██║  ██║██║██║ ╚███║   ██║   
#╚══════╝╚═╝  ╚══╝╚═════╝   ╚═╝     ╚═╝  ╚═╝╚═╝╚═╝  ╚══╝   ╚═╝  
[gcode_macro END_PRINT]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G1 X0 Y0


    # Disable steppers
    M84
    RESPOND TYPE=command MSG="END_PRINT: Perfil SKEW descarregado após término da impressão"
    SET_SKEW CLEAR=1

#██╗      █████╗  █████╗ ██████╗   ███████╗██╗██╗      █████╗ ███╗   ███╗███████╗███╗  ██╗████████╗
#██║     ██╔══██╗██╔══██╗██╔══██╗  ██╔════╝██║██║     ██╔══██╗████╗ ████║██╔════╝████╗ ██║╚══██╔══╝
#██║     ██║  ██║███████║██║  ██║  █████╗  ██║██║     ███████║██╔████╔██║█████╗  ██╔██╗██║   ██║   
#██║     ██║  ██║██╔══██║██║  ██║  ██╔══╝  ██║██║     ██╔══██║██║╚██╔╝██║██╔══╝  ██║╚████║   ██║   
#███████╗╚█████╔╝██║  ██║██████╔╝  ██║     ██║███████╗██║  ██║██║ ╚═╝ ██║███████╗██║ ╚███║   ██║   
#╚══════╝ ╚════╝ ╚═╝  ╚═╝╚═════╝   ╚═╝     ╚═╝╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝╚══════╝╚═╝  ╚══╝   ╚═╝  
[gcode_macro LOAD_FILAMENT]
gcode:
    MMU_LOAD

#██╗   ██╗███╗  ██╗██╗      █████╗  █████╗ ██████╗   ███████╗██╗██╗      █████╗ ███╗   ███╗███████╗███╗  ██╗████████╗
#██║   ██║████╗ ██║██║     ██╔══██╗██╔══██╗██╔══██╗  ██╔════╝██║██║     ██╔══██╗████╗ ████║██╔════╝████╗ ██║╚══██╔══╝
#██║   ██║██╔██╗██║██║     ██║  ██║███████║██║  ██║  █████╗  ██║██║     ███████║██╔████╔██║█████╗  ██╔██╗██║   ██║   
#██║   ██║██║╚████║██║     ██║  ██║██╔══██║██║  ██║  ██╔══╝  ██║██║     ██╔══██║██║╚██╔╝██║██╔══╝  ██║╚████║   ██║   
#╚██████╔╝██║ ╚███║███████╗╚█████╔╝██║  ██║██████╔╝  ██║     ██║███████╗██║  ██║██║ ╚═╝ ██║███████╗██║ ╚███║   ██║   
# ╚═════╝ ╚═╝  ╚══╝╚══════╝ ╚════╝ ╚═╝  ╚═╝╚═════╝   ╚═╝     ╚═╝╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝╚══════╝╚═╝  ╚══╝   ╚═╝ 
[gcode_macro UNLOAD_FILAMENT]
gcode:
    MMU_UNLOAD

[gcode_macro PRE_UNLOAD]
gcode:
    RESPOND TYPE=command MSG="PRE_UNLOAD: Perfil SKEW descarregado antes da troca de filamento"
    SET_SKEW CLEAR=1


#███████╗██╗██╗      █████╗ ███╗   ███╗███████╗███╗  ██╗████████  ██████╗ ███████╗████████╗███████╗ █████╗ ████████╗
#██╔════╝██║██║     ██╔══██╗████╗ ████║██╔════╝████╗ ██║╚══██╔══  ██╔══██╗██╔════╝╚══██╔══╝██╔════╝██╔══██╗╚══██╔══╝
#█████╗  ██║██║     ███████║██╔████╔██║█████╗  ██╔██╗██║   ██║    ██║  ██║█████╗     ██║   █████╗  ██║  ╚═╝   ██║   
#██╔══╝  ██║██║     ██╔══██║██║╚██╔╝██║██╔══╝  ██║╚████║   ██║    ██║  ██║██╔══╝     ██║   ██╔══╝  ██║  ██╗   ██║   
#██║     ██║███████╗██║  ██║██║ ╚═╝ ██║███████╗██║ ╚███║   ██║    ██████╔╝███████╗   ██║   ███████╗╚█████╔╝   ██║   
#╚═╝     ╚═╝╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝╚══════╝╚═╝  ╚══╝   ╚═╝    ╚═════╝ ╚══════╝   ╚═╝   ╚══════╝ ╚════╝    ╚═╝   

[save_variables]
filename: ~/printer_data/config/mmu/mmu_vars.cfg

# Macro para obter filamento restante
[gcode_macro GET_FILAMENT_REMAINING]
description: Retorna o valor do filamento restante
gcode:
    {% set remaining = printer.save_variables.variables.mmu_state_filament_remaining|default(0) %}
    {action_respond_info("Filamento restante: %d mm" % remaining)}
    SET_GCODE_VARIABLE MACRO=GET_FILAMENT_REMAINING VARIABLE=value VALUE={remaining}

variable_value: 0

# Macro para obter a cor do filamento restante
[gcode_macro GET_REMAINING_COLOR]
description: Retorna a cor do filamento restante
gcode:
    {% set color = printer.save_variables.variables.mmu_state_filament_remaining_color|default('ffffff') %}
    {action_respond_info("Cor do filamento restante: %s" % color)}
    SET_GCODE_VARIABLE MACRO=GET_REMAINING_COLOR VARIABLE=value VALUE='"{color}"'

variable_value: "ffffff"

# Macro para obter a cor do filamento ativo
[gcode_macro GET_ACTIVE_COLOR]
description: Retorna a cor do filamento ativo do Happy Hare
gcode:
    {% if printer.mmu.active_filament %}
        {% set filament_color = printer.mmu.active_filament.color %}
        {action_respond_info("Cor do filamento ativo: %s" % filament_color)}
        SET_GCODE_VARIABLE MACRO=GET_ACTIVE_COLOR VARIABLE=value VALUE='"{filament_color}"'
    {% else %}
        {action_respond_info("Nenhum filamento ativo detectado")}
        SET_GCODE_VARIABLE MACRO=GET_ACTIVE_COLOR VARIABLE=value VALUE='"none"'
    {% endif %}

variable_value: "none"

# Macro para capturar dados do filamento ANTES do carregamento# Macro para capturar dados do filamento ANTES do carregamento
[gcode_macro PRE_LOAD]
description: >
  Captura dados do filamento restante e cor ANTES do carregamento.
  Esta macro deve ser executada ANTES de qualquer troca de filamento
  para permitir verificação inteligente de cor na PURGA_MECANICA.
gcode:
    #Temporario para solucionar bug
    #MMU_TEST_CONFIG sync_to_extruder=1 QUIET=1
    # Capturar cor do filamento restante
    {% set remaining_color = printer.save_variables.variables.mmu_state_filament_remaining_color|default('ffffff') %}
    
    # Capturar comprimento do filamento restante
    {% set remaining_length = printer.save_variables.variables.mmu_state_filament_remaining|default(0) %}
    
    # Capturar cor do filamento ativo atual
    {% set current_active_color = printer.mmu.active_filament.color %}
    
    # Salvar nas variáveis da macro PRE_LOAD
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_remaining_color VALUE='"{remaining_color}"'
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_remaining_length VALUE={remaining_length}
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_active_color VALUE='"{current_active_color}"'
    
    {action_respond_info("PRE_LOAD: Cor restante capturada: %s" % remaining_color)}
    {action_respond_info("PRE_LOAD: Comprimento restante capturado: %d mm" % remaining_length)}
    {action_respond_info("PRE_LOAD: Cor ativa capturada: %s" % current_active_color)}

# Variáveis para armazenar os dados capturados
variable_saved_remaining_color: "ffffff"
variable_saved_remaining_length: 0
variable_saved_active_color: "none"


#██████╗ ██╗   ██╗██████╗  ██████╗ ███████╗
#██╔══██╗██║   ██║██╔══██╗██╔════╝ ██╔════╝
#██████╔╝██║   ██║██████╔╝██║  ██╗ █████╗  
#██╔═══╝ ██║   ██║██╔══██╗██║  ╚██╗██╔══╝  
#██║     ╚██████╔╝██║  ██║╚██████╔╝███████╗
#╚═╝      ╚═════╝ ╚═╝  ╚═╝ ╚═════╝ ╚══════╝
[gcode_macro PURGA_MMU]
# ==========================================================
# MACRO: PURGA_MMU - VERSÃO COM LIMPEZA DIAGONAL
# ==========================================================
# CORREÇÕES APLICADAS:
# - Retração garantida em todos os cenários de purga normal
# - Logging melhorado para rastrear execução da retração
# - Validação adicional de estado antes da retração
# - Mensagens informativas sempre visíveis (não só em DEBUG)
# - NOVO: Limpeza diagonal em escova retangular
# ==========================================================
description: >
  Purga mecânica com servo/escova integrada, ciclos curtos no balde, wipe diagonal e opção de retração.
  Verificação inteligente de cor na primeira purga para evitar desperdício.
  Velocidades de purga ajustadas automaticamente por material.
  Detecção de troca de material com volume fixo para limpeza completa do bico.
  Limpeza diagonal cruzada na escova retangular.
  Retração garantida em todos os cenários de purga.
  IMPORTANTE: Execute PRE_LOAD antes da troca de filamento!
  
  PARÂMETROS:
  • VOLUME=<valor>    → Volume de filamento a purgar em mm³
  • TESTE=<0|1|2>     → Modo: 0=purga normal (extrusão+servo), 1=só movimentos, 2=movimentos+servo
  • DEBUG=<0|1>       → Imprime cálculos e posições no console (0=off, 1=on)
  • RETRACT=<valor>   → Retração em mm após purga (0=sem retração)
gcode:
    RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW descarregado antes da purga"
    SET_SKEW CLEAR=1
    
    # Parâmetros de entrada
    {% set manual_volume = params.VOLUME|default(0)|float %}
    {% set teste_mode = params.TESTE|default(0)|int %}
    {% set debug = params.DEBUG|default(0)|int %}
    {% set manual_retract = params.RETRACT|default(-1)|float %}
    
    # ===== POSIÇÂO DO CENTRO DO BALDE DE PURGA =====
    {% set bucket_x = 122 %}
    {% set bucket_y = 333 %}
    {% set bucket_spread = 15 %}
    {% set purge_z = 20 %}    # Altura da mesa necessária para abertura da bandeja
    
    # --- COORDENADAS DA ESCOVA RETANGULAR ---
    {% set brush_x1 = 115 %}  # Canto inferior esquerdo X
    {% set brush_y1 = 310 %}  # Canto inferior esquerdo Y
    {% set brush_x2 = 129 %}  # Canto inferior direito X
    {% set brush_y2 = 310 %}  # Canto inferior direito Y
    {% set brush_x3 = 129 %}  # Canto superior direito X
    {% set brush_y3 = 324 %}  # Canto superior direito Y
    {% set brush_x4 = 115 %}  # Canto superior esquerdo X
    {% set brush_y4 = 324 %}  # Canto superior esquerdo Y
    
    # ===== VELOCIDADES DE PURGA POR MATERIAL =====
    {% set purge_speed_abs = 400 %}
    {% set purge_speed_tpu = 150 %}
    {% set purge_speed_pla = 400 %}
    {% set purge_speed_hips = 400 %}
    {% set purge_speed_petg = 350 %}
    {% set purge_speed_default = 400 %}
    
    {% set filament_diameter = 1.75 %}
    {% set purge_cycles = 5 %}
    {% set default_retract = 12 %}
    {% set brush_strokes = 3 %}
    {% set wipe_offset = 15 %}
    {% set safe_x = 150 %}
    {% set safe_y = 150 %}
    {% set first_purge_volume = 450 %}
    {% set same_color_margin = 3 %}
    {% set material_change_purge_volume = 850 %}
    
    # ===== DETECÇÃO DE MATERIAL E VELOCIDADE =====
    {% set active_material = printer.mmu.active_filament.material|default("")|string|upper %}
    
    {% if active_material == "TPU" %}
        {% set purge_feed = purge_speed_tpu %}
    {% elif active_material == "ABS" %}
        {% set purge_feed = purge_speed_abs %}
    {% elif active_material == "PLA" %}
        {% set purge_feed = purge_speed_pla %}
    {% elif active_material == "HIPS" %}
        {% set purge_feed = purge_speed_hips %}
    {% elif active_material == "PETG" %}
        {% set purge_feed = purge_speed_petg %}
    {% else %}
        {% set purge_feed = purge_speed_default %}
    {% endif %}
    
    {% if active_material != "" %}
        RESPOND TYPE=command MSG="PURGA_MMU: Material detectado: {active_material} | Velocidade: {purge_feed} mm/min"
    {% else %}
        RESPOND TYPE=command MSG="PURGA_MMU: Material não detectado, usando velocidade padrão: {purge_feed} mm/min"
    {% endif %}
    
    # ===== CONFIGURAÇÃO DA RETRAÇÃO =====
    {% set retract_after_purge = manual_retract if manual_retract >= 0 else default_retract %}
    
    # Mensagem sobre retração configurada
    {% if teste_mode == 0 %}
        {% if retract_after_purge > 0 %}
            RESPOND TYPE=command MSG="PURGA_MMU: Retração configurada: {retract_after_purge} mm"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: ATENÇÃO - Retração desabilitada (RETRACT=0)"
        {% endif %}
    {% else %}
        RESPOND TYPE=command MSG="PURGA_MMU: Modo teste {teste_mode} - Retração não será executada"
    {% endif %}
    
    # Obter número de trocas de ferramenta
    {% set num_toolchanges = printer.mmu.num_toolchanges|default(0)|int %}
    
    # ===== DETECÇÃO DE TROCA DE MATERIAL =====
    {% set last_tool = printer.mmu.last_tool|default(-1)|int %}
    {% set material_changed = false %}
    {% set last_material = "" %}
    
    {% if last_tool >= 0 %}
        {% set gate_materials = printer.mmu.gate_material %}
        {% if gate_materials is defined and gate_materials is iterable %}
            {% set last_material = gate_materials[last_tool]|default("")|string|upper %}
            {% if last_material != "" and active_material != "" and last_material != active_material %}
                {% set material_changed = true %}
            {% endif %}
        {% endif %}
    {% endif %}
    
    {% if debug %}
        RESPOND TYPE=command MSG="PURGA_MMU: Último gate: {last_tool} | Material anterior: {last_material}"
        RESPOND TYPE=command MSG="PURGA_MMU: Material atual: {active_material} | Troca de material: {material_changed}"
    {% endif %}
    
    # ===== LÓGICA DE DETERMINAÇÃO DO VOLUME DE PURGA =====
    {% if manual_volume > 0 %}
        {% set purge_volume = manual_volume %}
        {% set volume_source = "manual" %}
        
    {% elif material_changed %}
        {% set purge_volume = material_change_purge_volume %}
        {% set volume_source = "troca_material" %}
        
        RESPOND TYPE=command MSG="PURGA_MMU: *** TROCA DE MATERIAL DETECTADA ***"
        RESPOND TYPE=command MSG="PURGA_MMU: {last_material} → {active_material}"
        RESPOND TYPE=command MSG="PURGA_MMU: Volume fixo para limpeza: {purge_volume|round(1)}mm³"
        RESPOND TYPE=command MSG="PURGA_MMU: (Ignorando mapa de purga e verificação de cor)"
        
    {% elif num_toolchanges == 0 %}
        # PRIMEIRA PURGA - VERIFICAR CORES
        {% set saved_remaining_color = printer["gcode_macro PRE_LOAD"].saved_remaining_color|string|replace('"', '') %}
        {% set saved_remaining_length = printer["gcode_macro PRE_LOAD"].saved_remaining_length|float %}
        {% set saved_active_color = printer["gcode_macro PRE_LOAD"].saved_active_color|string|replace('"', '') %}
        
        {% if debug %}
            RESPOND TYPE=command MSG="PURGA_MMU: Cor restante (salva): '{saved_remaining_color}' | Comprimento restante (salvo): {saved_remaining_length}mm"
            RESPOND TYPE=command MSG="PURGA_MMU: Cor ativa (salva): '{saved_active_color}'"
        {% endif %}
        
        {% if saved_remaining_color|lower == saved_active_color|lower and saved_remaining_color != "ffffff" and saved_active_color != "none" %}
            {% if saved_remaining_length > 0 %}
                {% set optimized_length = saved_remaining_length * same_color_margin %}
                {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}
                {% set purge_volume = optimized_length * filament_area %}
                {% set volume_source = "mesma_cor_otimizada" %}
                
                RESPOND TYPE=command MSG="PURGA_MMU: *** MESMA COR DETECTADA *** Filamento restante: {saved_remaining_length|round(1)}mm"
                RESPOND TYPE=command MSG="PURGA_MMU: Cores: {saved_remaining_color} = {saved_active_color}"
                RESPOND TYPE=command MSG="PURGA_MMU: Volume otimizado: {purge_volume|round(1)}mm³ (economia de filamento!)"
            {% else %}
                {% set purge_volume = first_purge_volume %}
                {% set volume_source = "primeira_purga_fallback" %}
                RESPOND TYPE=command MSG="PURGA_MMU: Mesma cor detectada, mas sem dados de comprimento válidos. Usando volume padrão."
            {% endif %}
        {% else %}
            {% set purge_volume = first_purge_volume %}
            {% set volume_source = "primeira_purga_cor_diferente" %}
            
            {% if saved_remaining_color == "ffffff" or saved_active_color == "none" %}
                RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Dados de cor indisponíveis. Volume padrão: {purge_volume|round(1)}mm³"
                RESPOND TYPE=command MSG="PURGA_MMU: DICA: Execute PRE_LOAD antes da troca para verificação de cor!"
            {% else %}
                RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Cores diferentes detectadas:"
                RESPOND TYPE=command MSG="PURGA_MMU: Restante: {saved_remaining_color} ≠ Ativa: {saved_active_color}"
                RESPOND TYPE=command MSG="PURGA_MMU: Volume padrão: {purge_volume|round(1)}mm³"
            {% endif %}
        {% endif %}
    {% else %}
        {% set purge_volume = printer.mmu.toolchange_purge_volume %}
        {% set volume_source = "normal" %}
    {% endif %}

    {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}
    {% set purge_length = purge_volume / filament_area %}
    {% set cycle_length = (purge_length / purge_cycles) if purge_cycles|int > 0 else 0 %}

    {% if num_toolchanges == 0 %}
        RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** - Trocas: {num_toolchanges} | Volume: {purge_volume|round(1)} mm³ | Fonte: {volume_source}"
    {% endif %}

    RESPOND TYPE=command MSG="PURGA_MMU: Purga: {purge_volume|round(1)} mm³ ({purge_length|round(1)} mm) | TESTE={teste_mode} | DEBUG={debug} | Fonte: {volume_source}"
    
    {% if debug %}
      RESPOND TYPE=command MSG="PURGA_MMU: Trocas de ferramenta: {num_toolchanges}"
      RESPOND TYPE=command MSG="PURGA_MMU: Material ativo: {active_material}"
      RESPOND TYPE=command MSG="PURGA_MMU: Velocidade de purga: {purge_feed} mm/min"
      RESPOND TYPE=command MSG="PURGA_MMU: Centro balde: X{bucket_x} Y{bucket_y}"
      RESPOND TYPE=command MSG="PURGA_MMU: Área escova: C1({brush_x1},{brush_y1}) C2({brush_x2},{brush_y2}) C3({brush_x3},{brush_y3}) C4({brush_x4},{brush_y4})"
      RESPOND TYPE=command MSG="PURGA_MMU: Ciclos de purga: {purge_cycles} | Por ciclo: {cycle_length|round(2)} mm"
      RESPOND TYPE=command MSG="PURGA_MMU: Passadas de limpeza diagonal: {brush_strokes}"
      RESPOND TYPE=command MSG="PURGA_MMU: Retração após purga: {retract_after_purge} mm"
    {% endif %}

    SAVE_GCODE_STATE NAME=PURGA_MMU_STATE

    {% set current_z = printer.toolhead.position.z %}
    {% if current_z < purge_z %}
      G90
      G1 Z{purge_z} F3000
    {% endif %}

    # --- ABRE BANDEJA ---
    {% if teste_mode != 1 %}
      PURGE_SERVO_OPEN
      G4 P500
    {% endif %}

    # --- PURGA NO BALDE ---
    G90
    MMU_SYNC_GEAR_MOTOR SYNC=1
    G1 X{bucket_x} Y{bucket_y} F7800
    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Na posição do balde" {% endif %}

    {% if teste_mode == 0 %}
      # ===== INÍCIO DA PURGA COM EXTRUSÃO =====
      G91  # Modo relativo para extrusão
      
      {% for i in range(purge_cycles|int) %}
        {% set x_offset = (bucket_spread / (purge_cycles - 1)) * i - (bucket_spread / 2) if purge_cycles > 1 else 0 %}
        {% set target_x = bucket_x + x_offset %}
        
        G90  # Modo absoluto para movimento XY
        G1 X{target_x} F7800
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {i+1}: X{target_x|round(1)}" {% endif %}
        
        G91  # Modo relativo para extrusão
        G1 E{cycle_length|round(2)} F{purge_feed}
        G4 P200
      {% endfor %}
      
      # ===== RETRAÇÃO APÓS PURGA =====
      # Garantir que estamos em modo relativo
      G91
      
      {% if retract_after_purge|float > 0 %}
        RESPOND TYPE=command MSG="PURGA_MMU: >>> Executando retração de {retract_after_purge} mm <<<"
        G1 E-{retract_after_purge|float} F2400
        G4 P100  # Pequena pausa para garantir execução
        RESPOND TYPE=command MSG="PURGA_MMU: >>> Retração concluída <<<"
      {% else %}
        RESPOND TYPE=command MSG="PURGA_MMU: >>> ATENÇÃO: Retração pulada (valor: {retract_after_purge}) <<<"
      {% endif %}
      
      # Voltar para modo absoluto
      G90
    {% else %}
      # Modo teste - sem extrusão
      RESPOND TYPE=command MSG="PURGA_MMU: Modo teste {teste_mode} - Pulando extrusão e retração"
    {% endif %}

    # --- LIMPEZA NA ESCOVA (MOVIMENTOS DIAGONAIS CRUZADOS) ---
    RESPOND TYPE=command MSG="PURGA_MMU: Iniciando limpeza diagonal na escova retangular"
    
    # Movimento inicial para o primeiro canto (inferior esquerdo)
    G90
    G1 X{brush_x1} Y{brush_y1} F6000
    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Posição inicial - Canto 1: X{brush_x1} Y{brush_y1}" {% endif %}
    
    # Zigue-zague diagonal cruzado
    {% for i in range(brush_strokes|int) %}
        {% if i % 2 == 0 %}
            # Diagonal ascendente: Canto 1 → Canto 3 (esquerda-baixo → direita-cima)
            G1 X{brush_x3} Y{brush_y3} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/A - Diagonal ↗ (C1→C3)" {% endif %}
            # Move para Canto 2 (inferior direito)
            G1 X{brush_x2} Y{brush_y2} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/B - Move para C2" {% endif %}
            # Diagonal ascendente: Canto 2 → Canto 4 (direita-baixo → esquerda-cima)
            G1 X{brush_x4} Y{brush_y4} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/C - Diagonal ↖ (C2→C4)" {% endif %}
            # Retorna para Canto 1
            G1 X{brush_x1} Y{brush_y1} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/D - Retorna C1" {% endif %}
        {% else %}
            # Diagonal descendente: Canto 4 → Canto 2 (esquerda-cima → direita-baixo)
            G1 X{brush_x4} Y{brush_y4} F3000
            G1 X{brush_x2} Y{brush_y2} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/A - Diagonal ↘ (C4→C2)" {% endif %}
            # Move para Canto 3 (superior direito)
            G1 X{brush_x3} Y{brush_y3} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/B - Move para C3" {% endif %}
            # Diagonal descendente: Canto 3 → Canto 1 (direita-cima → esquerda-baixo)
            G1 X{brush_x1} Y{brush_y1} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/C - Diagonal ↙ (C3→C1)" {% endif %}
        {% endif %}
    {% endfor %}

    # --- WIPE FINAL ---
    # Sai pela parte superior central da escova
    {% set exit_x = (brush_x3 + brush_x4) / 2 %}
    {% set exit_y = brush_y3 + wipe_offset %}
    G90
    G1 X{exit_x} Y{exit_y} F3000
    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Saída - X{exit_x|round(1)} Y{exit_y|round(1)}" {% endif %}

    # --- SAFE POSITION ---
    G1 X{safe_x} Y{safe_y} F7800

    # --- RECOLHE BANDEJA ---
    {% if teste_mode != 1 %}
      PURGE_SERVO_CLOSE
      G4 P500
    {% endif %}

    RESTORE_GCODE_STATE NAME=PURGA_MMU_STATE
    RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW carregado após a purga"
    SKEW_PROFILE LOAD=skew_profile
    
    # Mensagem final de confirmação
    {% if teste_mode == 0 %}
        {% if retract_after_purge > 0 %}
            RESPOND TYPE=command MSG="PURGA_MMU: ✓ Purga e retração concluídas com sucesso"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: ✓ Purga concluída (sem retração)"
        {% endif %}
    {% else %}
        RESPOND TYPE=command MSG="PURGA_MMU: ✓ Teste de movimentos concluído"
    {% endif %}

# █████╗ ██╗   ██╗████████╗████████╗██╗███╗  ██╗ ██████╗    ██████╗███████╗██████╗ ██╗   ██╗ █████╗ 
#██╔══██╗██║   ██║╚══██╔══╝╚══██╔══╝██║████╗ ██║██╔════╝   ██╔════╝██╔════╝██╔══██╗██║   ██║██╔══██╗
#██║  ╚═╝██║   ██║   ██║      ██║   ██║██╔██╗██║██║  ██╗   ╚█████╗ █████╗  ██████╔╝╚██╗ ██╔╝██║  ██║
#██║  ██╗██║   ██║   ██║      ██║   ██║██║╚████║██║  ╚██╗   ╚═══██╗██╔══╝  ██╔══██╗ ╚████╔╝ ██║  ██║
#╚█████╔╝╚██████╔╝   ██║      ██║   ██║██║ ╚███║╚██████╔╝  ██████╔╝███████╗██║  ██║  ╚██╔╝  ╚█████╔╝
# ╚════╝  ╚═════╝    ╚═╝      ╚═╝   ╚═╝╚═╝  ╚══╝ ╚═════╝   ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝    ╚════╝ 


# Macro para abrir o servo de corte de filamento
[gcode_macro CUTTING_SERVO_OPEN]
gcode:
    _CUT_TIP_GANTRY_SERVO_DOWN

# Macro para fechar o servo de corte de filamento
[gcode_macro CUTTING_SERVO_CLOSE]
gcode:
    _CUT_TIP_GANTRY_SERVO_UP

#██████╗ ██╗   ██╗███╗   ███╗██████╗ ██╗   ██╗ █████╗ ██████╗ ██╗ █████╗ ██████╗ ██╗     ███████╗ ██████╗
#██╔══██╗██║   ██║████╗ ████║██╔══██╗██║   ██║██╔══██╗██╔══██╗██║██╔══██╗██╔══██╗██║     ██╔════╝██╔════╝
#██║  ██║██║   ██║██╔████╔██║██████╔╝╚██╗ ██╔╝███████║██████╔╝██║███████║██████╦╝██║     █████╗  ╚█████╗ 
#██║  ██║██║   ██║██║╚██╔╝██║██╔═══╝  ╚████╔╝ ██╔══██║██╔══██╗██║██╔══██║██╔══██╗██║     ██╔══╝   ╚═══██╗
#██████╔╝╚██████╔╝██║ ╚═╝ ██║██║       ╚██╔╝  ██║  ██║██║  ██║██║██║  ██║██████╦╝███████╗███████╗██████╔╝
#╚═════╝  ╚═════╝ ╚═╝     ╚═╝╚═╝        ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝╚══════╝╚═════╝ 

[gcode_macro DUMP_VARIABLES]
description: >
    Isso exibe todas as variáveis atuais do Klipper no terminal de código G.
    Isso ajuda a encontrar variáveis de sistema do Klipper para uso em macros. É possível aplicar um filtro tanto por nome quanto por valor.
    Argumentos
        NAME (string) - Filtrar resultados com base no nome (mostrar apenas variáveis com nomes que contenham esta string)
        VALUE (string) - Filtrar resultados com base no valor (mostrar apenas valores que contenham esse valor)
        SHOW_CFG (número inteiro, 0-1) - Defina como 1 para incluir toda a configuração na saída. O padrão é 0 (configuração filtrada).
    Exemplos
        DUMP_VARIABLES: Retorna todas as variáveis (exceto ` printer['configfile'].configand` printer['configfile'].settings, pois elas contêm toda a configuração).
        DUMP_VARIABLES NAME=stepperRetorna todas as variáveis que contêm a string stepperem seus nomes.
        DUMP_VARIABLES VALUE=extruderRetorna todas as variáveis que contêm a string extruderem seu valor.
        DUMP_VARIABLES NAME=stepper VALUE=extruderRetorna todas as variávei que têm a string stepperem seu nome e a string extruderem seu valor.
        DUMP_VARIABLES SHOW_CFG=1Retorna todas as variáveis, incluindo a configuração.
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    
    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {action_respond_info(out|join("\n"))}

# ██████╗ ███████╗████████╗██╗   ██╗ █████╗ ██████╗ ██╗ █████╗ ██████╗ ██╗     ███████╗
#██╔════╝ ██╔════╝╚══██╔══╝██║   ██║██╔══██╗██╔══██╗██║██╔══██╗██╔══██╗██║     ██╔════╝
#██║  ██╗ █████╗     ██║   ╚██╗ ██╔╝███████║██████╔╝██║███████║██████╦╝██║     █████╗  
#██║  ╚██╗██╔══╝     ██║    ╚████╔╝ ██╔══██║██╔══██╗██║██╔══██║██╔══██╗██║     ██╔══╝  
#╚██████╔╝███████╗   ██║     ╚██╔╝  ██║  ██║██║  ██║██║██║  ██║██████╦╝███████╗███████╗
# ╚═════╝ ╚══════╝   ╚═╝      ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝╚══════╝

[gcode_macro GET_VARIABLE]
description: >
 Esta função retorna o valor e o tipo de uma única variável para o terminal de código G. 
 Chaves e índices podem ser encadeados para acessar dicionários e listas aninhados.
 Exemplos:
    GET_VARIABLE NAME=toolhead: Retorna o valor e o tipo da variável printer.toolhead.
    GET_VARIABLE NAME=bed_mesh.profiles.default.points.1.0: Retorna o valor e o tipo da variável printer.bed_mesh.profiles.default.points[1][0].
gcode:
    {% set names = (params.NAME).split('.')|list %}
    {% set join = (params.JOIN)|default(1)|int %}
    
    {% set _dummy0 = namespace( break = 0 ) %}
    {% set _dummy1 = namespace( out = printer[names|first] ) %}
    
    {% for name in names if _dummy0.break == 0 %}
        {% if loop.index > 1 %}
            {% if name in _dummy1.out %}
                {% set _dummy1.out = _dummy1.out[name] %}
            {% elif name[0] in '0123456789' and _dummy1.out is iterable and _dummy1.out is not string and _dummy1.out is not mapping and _dummy1.out|length > name[0]|int %}
                {% set _dummy1.out = _dummy1.out[name|int] %}
            {% else %}
                {% set _dummy0.break = loop.index0 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    {% if _dummy1.out is boolean %}
        { action_respond_info('Type: boolean') }
    {% elif _dummy1.out is float %}
        { action_respond_info('Type: float') }
    {% elif _dummy1.out is integer %}
        { action_respond_info('Type: integer') }
    {% elif _dummy1.out is mapping %}
        { action_respond_info('Type: mapping') }
    {% elif _dummy1.out is string %}
        { action_respond_info('Type: string') }
    {% elif _dummy1.out is iterable %}
        { action_respond_info('Type: iterable') }
    {% elif _dummy1.out is none %}
        { action_respond_info('Type: none') }
    {% elif _dummy1.out is undefined %}
        { action_respond_info('Type: undefined') }
    {% elif _dummy1.out is callable %}
        { action_respond_info('Type: callable') }
    {% else %}
        { action_respond_info('Type: unknown') }
    {% endif %}
    
    {% if join and _dummy1.out is iterable and _dummy1.out is not string and _dummy1.out is not mapping %}
        { action_respond_info('%s' % _dummy1.out|join("\n")) }
    {% else %}
        { action_respond_info('%s' % _dummy1.out) }
    {% endif %}
    
    {% if _dummy0.break != 0 %}
        { action_respond_info('"printer.%s" does not contain "%s"!' % (names[0:_dummy0.break]|join('.'), names[_dummy0.break])) }
    {% endif %}

#████████╗███████╗██╗     ███████╗ ██████╗ ██████╗  █████╗ ███╗   ███╗
#╚══██╔══╝██╔════╝██║     ██╔════╝██╔════╝ ██╔══██╗██╔══██╗████╗ ████║
#   ██║   █████╗  ██║     █████╗  ██║  ██╗ ██████╔╝███████║██╔████╔██║
#   ██║   ██╔══╝  ██║     ██╔══╝  ██║  ╚██╗██╔══██╗██╔══██║██║╚██╔╝██║
#   ██║   ███████╗███████╗███████╗╚██████╔╝██║  ██║██║  ██║██║ ╚═╝ ██║
#   ╚═╝   ╚══════╝╚══════╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚═╝

[gcode_macro user_pause_extension ]
description: Envia uma notificação para o bot telegram quando a imporessão for pausada
gcode:
    RESPOND PREFIX=tgnotify MSG="Impressão pausada"

[gcode_macro user_resume_extension ]
description: Envia uma notificação para o bot telegram quando a imporessão for retomada
gcode:
    RESPOND PREFIX=tgnotify MSG="Impressão retomada"
   
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
# ‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù 
[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    # Start bed heating
    M140 S{BED_TEMP}
    #Seta temperatura do extrusor e aguarda
    RESPOND MSG="Aguardando aquecimento do bico"
    M109 S{EXTRUDER_TEMP}
    
    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset
    SET_GCODE_OFFSET Z=0.0
    # Home the printer
    G28
    # Wait for bed to reach temperature
    M190 S{BED_TEMP}
    #Executa nivelamento da mesa 
    BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX}
    # Log inicial com o valor atual da vari√°vel
    RESPOND MSG=" START_PRINT: [MMU BYPASS CHECK] Verificando tool atual: {printer.mmu.tool}"
    {% if printer.mmu.tool == -1 or printer.mmu.tool == -2 %}
        # Tool √© -1 ou -2, executa movimento direto
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Tool √© {printer.mmu.tool} Usando porta de Bypass - Executando movimento direto G1 X0 Y2.50 Z0.78 F2400"
        G1 X0 Y2.50 Z0.78 F2400
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Movimento direto conclu√≠do"
        MMU_TEST_CONFIG enable_clog_detection=0
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Desativando detec√£o de obstru√ß√£o"
    {% else %}
        # Tool n√£o √© -1 nem -2, executa macro PURGA_PREUNLOAD
        RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Tool √© {printer.mmu.tool} - Impress√£o sem Bypass"
    {% endif %}
    
    RESPOND MSG="START_PRINT: [MMU BYPASS CHECK] Verifica√ß√£o de BYPASS  finalizada"
    RESPOND TYPE=command MSG="START_PRINT: Perfil SKEW carregado no in√≠cio da impress√£o"
    SKEW_PROFILE LOAD=skew_profile
    GET_CURRENT_SKEW

   

#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù  
[gcode_macro END_PRINT]
gcode:
    #Salva no disco os dados do ultimo filamento utilizado 
    SAVE_LAST_TOOL_INFO
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Realiza a limpeza da escova
    PURGA_MMU ONLY_CLEAN=1
    # Desativa os motores
    M84
    RESPOND TYPE=command MSG="END_PRINT: Perfil SKEW descarregado ap√≥s t√©rmino da impress√£o"
    SET_SKEW CLEAR=1

#‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù  
[gcode_macro LOAD_FILAMENT]
gcode:
    MMU_LOAD

#‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
#‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù 
[gcode_macro UNLOAD_FILAMENT]
gcode:
    MMU_UNLOAD

[gcode_macro PRE_UNLOAD]
gcode:
    RESPOND TYPE=command MSG="PRE_UNLOAD: Perfil SKEW descarregado antes da troca de filamento"
    SET_SKEW CLEAR=1


#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ïö‚ïê‚ïù   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   
#‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   
#‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù   


[gcode_macro SAVE_LAST_TOOL_INFO]
description: Salva cor e material da √∫ltima ferramenta utilizada
gcode:
    {% set last_tool = printer.mmu.last_tool|int %}
    {% set last_color = printer.mmu.gate_color[last_tool] %}
    {% set last_material = printer.mmu.gate_material[last_tool] %}
    
    # Salva as informa√ß√µes em vari√°veis permanentes
    SAVE_VARIABLE VARIABLE=last_tool_number VALUE={last_tool}
    SAVE_VARIABLE VARIABLE=last_tool_color VALUE='"{last_color}"'
    SAVE_VARIABLE VARIABLE=last_tool_material VALUE='"{last_material}"'
    
    # Feedback
    {action_respond_info("Informa√ß√µes da ferramenta %d salvas:" % (last_tool))}
    {action_respond_info("  Cor: %s" % (last_color))}
    {action_respond_info("  Material: %s" % (last_material))}


[save_variables]
filename: ~/printer_data/config/mmu/mmu_vars.cfg

# Macro para obter filamento restante
[gcode_macro GET_FILAMENT_REMAINING]
description: Retorna o valor do filamento restante
gcode:
    {% set remaining = printer.save_variables.variables.mmu_state_filament_remaining|default(0) %}
    {action_respond_info("Filamento restante: %d mm" % remaining)}
    SET_GCODE_VARIABLE MACRO=GET_FILAMENT_REMAINING VARIABLE=value VALUE={remaining}

variable_value: 0

# Macro para obter a cor do filamento restante
[gcode_macro GET_REMAINING_COLOR]
description: Retorna a cor do filamento restante
gcode:
    {% set color = printer.save_variables.variables.mmu_state_filament_remaining_color|default('ffffff') %}
    {action_respond_info("Cor do filamento restante: %s" % color)}
    SET_GCODE_VARIABLE MACRO=GET_REMAINING_COLOR VARIABLE=value VALUE='"{color}"'

variable_value: "ffffff"

# Macro para obter a cor do filamento ativo
[gcode_macro GET_ACTIVE_COLOR]
description: Retorna a cor do filamento ativo do Happy Hare
gcode:
    {% if printer.mmu.active_filament %}
        {% set filament_color = printer.mmu.active_filament.color %}
        {action_respond_info("Cor do filamento ativo: %s" % filament_color)}
        SET_GCODE_VARIABLE MACRO=GET_ACTIVE_COLOR VARIABLE=value VALUE='"{filament_color}"'
    {% else %}
        {action_respond_info("Nenhum filamento ativo detectado")}
        SET_GCODE_VARIABLE MACRO=GET_ACTIVE_COLOR VARIABLE=value VALUE='"none"'
    {% endif %}

variable_value: "none"

# Macro para capturar dados do filamento ANTES do carregamento# Macro para capturar dados do filamento ANTES do carregamento
[gcode_macro PRE_LOAD]
description: >
  Captura dados do filamento restante e cor ANTES do carregamento.
  Esta macro deve ser executada ANTES de qualquer troca de filamento
  para permitir verifica√ß√£o inteligente de cor na PURGA_MECANICA.
gcode:
    #Temporario para solucionar bug
    #MMU_TEST_CONFIG sync_to_extruder=1 QUIET=1
    # Capturar cor do filamento restante
    {% set remaining_color = printer.save_variables.variables.mmu_state_filament_remaining_color|default('ffffff') %}
    
    # Capturar comprimento do filamento restante
    {% set remaining_length = printer.save_variables.variables.mmu_state_filament_remaining|default(0) %}
    
    # Capturar cor do filamento ativo atual
    {% set current_active_color = printer.mmu.active_filament.color %}
    
    # Salvar nas vari√°veis da macro PRE_LOAD
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_remaining_color VALUE='"{remaining_color}"'
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_remaining_length VALUE={remaining_length}
    SET_GCODE_VARIABLE MACRO=PRE_LOAD VARIABLE=saved_active_color VALUE='"{current_active_color}"'
    
    {action_respond_info("PRE_LOAD: Cor restante capturada: %s" % remaining_color)}
    {action_respond_info("PRE_LOAD: Comprimento restante capturado: %d mm" % remaining_length)}
    {action_respond_info("PRE_LOAD: Cor ativa capturada: %s" % current_active_color)}

# Vari√°veis para armazenar os dados capturados
variable_saved_remaining_color: "ffffff"
variable_saved_remaining_length: 0
variable_saved_active_color: "none"


#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
#‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
[gcode_macro PURGA_MMU]
# ==========================================================
# MACRO: PURGA_MMU - VERS√ÉO COM LIMPEZA DIAGONAL E DIVIS√ÉO DE PURGA
# ==========================================================
# CORRE√á√ïES APLICADAS:
# - Retra√ß√£o garantida em todos os cen√°rios de purga normal
# - Logging melhorado para rastrear execu√ß√£o da retra√ß√£o
# - Valida√ß√£o adicional de estado antes da retra√ß√£o
# - Mensagens informativas sempre vis√≠veis (n√£o s√≥ em DEBUG)
# - Limpeza diagonal em escova retangular
# - Divis√£o autom√°tica de purgas >500mm¬≥ em 2 ciclos completos
# - NOVO: Par√¢metro ONLY_CLEAN para executar apenas limpeza (sem purga)
# ==========================================================
description: >
  Purga mec√¢nica com servo/escova integrada, ciclos curtos no balde, wipe diagonal e op√ß√£o de retra√ß√£o.
  NOVA: Verifica√ß√£o inteligente de cor na primeira purga para evitar desperd√≠cio.
  NOVA: Velocidades de purga ajustadas automaticamente por material.
  NOVA: Detec√ß√£o de troca de material com volume fixo para limpeza completa do bico.
  NOVA: Limpeza diagonal cruzada na escova retangular.
  NOVA: Divis√£o autom√°tica de purgas grandes em 2 ciclos para esvaziar bandeja.
  NOVA: Modo ONLY_CLEAN para executar apenas limpeza na escova (sem purga).
  CORRE√á√ÉO: Retra√ß√£o garantida em todos os cen√°rios de purga.
  IMPORTANTE: Execute PRE_LOAD antes da troca de filamento!
  
  PAR√ÇMETROS:
  ‚Ä¢ VOLUME=<valor>    ‚Üí Volume de filamento a purgar em mm¬≥
  ‚Ä¢ TESTE=<0|1|2>     ‚Üí Modo: 0=purga normal (extrus√£o+servo), 1=s√≥ movimentos, 2=movimentos+servo
  ‚Ä¢ DEBUG=<0|1>       ‚Üí Imprime c√°lculos e posi√ß√µes no console (0=off, 1=on)
  ‚Ä¢ RETRACT=<valor>   ‚Üí Retra√ß√£o em mm ap√≥s purga (0=sem retra√ß√£o)
  ‚Ä¢ ONLY_CLEAN=<0|1>  ‚Üí 1=apenas limpeza na escova (sem purga, sem servo), 0=purga normal
gcode:
    # ==========================================================
    # PAR√ÇMETROS DE ENTRADA
    # ==========================================================
    {% set manual_volume = params.VOLUME|default(0)|float %}
    {% set teste_mode = params.TESTE|default(0)|int %}
    {% set debug = params.DEBUG|default(0)|int %}
    {% set manual_retract = params.RETRACT|default(-1)|float %}
    {% set only_clean = params.ONLY_CLEAN|default(0)|int %}
    
    # ==========================================================
    # CONFIGURA√á√ïES FIXAS DA MACRO
    # ==========================================================
    # Posi√ß√µes do balde de purga
    {% set bucket_x = 122 %}
    {% set bucket_y = 333 %}
    {% set bucket_spread = 15 %}
    {% set purge_z = 20 %}
    {% set max_volume_per_cycle = 500 %}  # Volume m√°ximo antes de dividir em 2 ciclos
    
    # Coordenadas da escova retangular
    {% set brush_x1 = 110 %}  # Canto inferior esquerdo X
    {% set brush_y1 = 317 %}  # Canto inferior esquerdo Y
    {% set brush_x2 = 145 %}  # Canto inferior direito X
    {% set brush_y2 = 317 %}  # Canto inferior direito Y
    {% set brush_x3 = 145 %}  # Canto superior direito X
    {% set brush_y3 = 326 %}  # Canto superior direito Y
    {% set brush_x4 = 110 %}  # Canto superior esquerdo X
    {% set brush_y4 = 326 %}  # Canto superior esquerdo Y
    
    # Velocidades de purga por material (mm/min)
    {% set purge_speed_abs = 400 %}
    {% set purge_speed_tpu = 150 %}
    {% set purge_speed_pla = 400 %}
    {% set purge_speed_hips = 400 %}
    {% set purge_speed_petg = 350 %}
    {% set purge_speed_default = 400 %}
    
    # Configura√ß√µes gerais
    {% set filament_diameter = 1.75 %}
    {% set purge_cycles = 5 %}
    {% set default_retract = 12 %}
    {% set brush_strokes = 3 %}
    {% set wipe_offset = 10 %}
    {% set safe_x = 245 %}
    {% set safe_y = 300 %}
    {% set first_purge_volume = 450 %}
    {% set same_color_margin = 3 %}
    {% set material_change_purge_volume = 850 %}
    
    # ==========================================================
    # MODO ONLY_CLEAN - APENAS LIMPEZA SEM PURGA
    # ==========================================================
    {% if only_clean == 1 %}
        RESPOND TYPE=command MSG="PURGA_MMU: ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        RESPOND TYPE=command MSG="PURGA_MMU: ‚ïë  MODO: APENAS LIMPEZA (ONLY_CLEAN)  ‚ïë"
        RESPOND TYPE=command MSG="PURGA_MMU: ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        
        SAVE_GCODE_STATE NAME=PURGA_MMU_CLEAN_STATE
        
        # Subir Z se necess√°rio
        {% set current_z = printer.toolhead.position.z %}
        {% if current_z < purge_z %}
            G90
            G1 Z{purge_z} F3000
        {% endif %}
        
        # --- LIMPEZA NA ESCOVA (MOVIMENTOS DIAGONAIS CRUZADOS) ---
        RESPOND TYPE=command MSG="PURGA_MMU: Iniciando limpeza diagonal na escova (sem purga)"
        
        # Movimento inicial para o primeiro canto (inferior esquerdo)
        G90
        G1 X{brush_x1} Y{brush_y1} F6000
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Posi√ß√£o inicial - Canto 1: X{brush_x1} Y{brush_y1}" {% endif %}
        
        # Zigue-zague diagonal cruzado
        {% for i in range(brush_strokes|int) %}
            {% if i % 2 == 0 %}
                # Diagonal ascendente: Canto 1 ‚Üí Canto 3 (esquerda-baixo ‚Üí direita-cima)
                G1 X{brush_x3} Y{brush_y3} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/A - Diagonal ‚Üó (C1‚ÜíC3)" {% endif %}
                # Move para Canto 2 (inferior direito)
                G1 X{brush_x2} Y{brush_y2} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/B - Move para C2" {% endif %}
                # Diagonal ascendente: Canto 2 ‚Üí Canto 4 (direita-baixo ‚Üí esquerda-cima)
                G1 X{brush_x4} Y{brush_y4} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/C - Diagonal ‚Üñ (C2‚ÜíC4)" {% endif %}
                # Retorna para Canto 1
                G1 X{brush_x1} Y{brush_y1} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/D - Retorna C1" {% endif %}
            {% else %}
                # Diagonal descendente: Canto 4 ‚Üí Canto 2 (esquerda-cima ‚Üí direita-baixo)
                G1 X{brush_x4} Y{brush_y4} F3000
                G1 X{brush_x2} Y{brush_y2} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/A - Diagonal ‚Üò (C4‚ÜíC2)" {% endif %}
                # Move para Canto 3 (superior direito)
                G1 X{brush_x3} Y{brush_y3} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/B - Move para C3" {% endif %}
                # Diagonal descendente: Canto 3 ‚Üí Canto 1 (direita-cima ‚Üí esquerda-baixo)
                G1 X{brush_x1} Y{brush_y1} F3000
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Stroke {i+1}/C - Diagonal ‚Üô (C3‚ÜíC1)" {% endif %}
            {% endif %}
        {% endfor %}
        
        # --- WIPE FINAL ---
        {% set exit_x = brush_x3 + wipe_offset %}
        {% set exit_y = (brush_y3 + brush_y2) / 2 %}
        G90
        G1 X{exit_x} Y{exit_y} F3000
        {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Sa√≠da lateral - X{exit_x|round(1)} Y{exit_y|round(1)}" {% endif %}
        
        RESTORE_GCODE_STATE NAME=PURGA_MMU_CLEAN_STATE
        RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Limpeza conclu√≠da (modo ONLY_CLEAN)"
        
    {% else %}
        # ==========================================================
        # MODO NORMAL - PURGA COMPLETA
        # ==========================================================
        RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW descarregado antes da purga"
        SET_SKEW CLEAR=1
        
        # ==========================================================
        # DETEC√á√ÉO DE MATERIAL E VELOCIDADE
        # ==========================================================
        {% set active_material = printer.mmu.active_filament.material|default("")|string|upper %}
        
        {% if active_material == "TPU" %}
            {% set purge_feed = purge_speed_tpu %}
        {% elif active_material == "ABS" %}
            {% set purge_feed = purge_speed_abs %}
        {% elif active_material == "PLA" %}
            {% set purge_feed = purge_speed_pla %}
        {% elif active_material == "HIPS" %}
            {% set purge_feed = purge_speed_hips %}
        {% elif active_material == "PETG" %}
            {% set purge_feed = purge_speed_petg %}
        {% else %}
            {% set purge_feed = purge_speed_default %}
        {% endif %}
        
        {% if active_material != "" %}
            RESPOND TYPE=command MSG="PURGA_MMU: Material detectado: {active_material} | Velocidade: {purge_feed} mm/min"
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Material n√£o detectado, usando velocidade padr√£o: {purge_feed} mm/min"
        {% endif %}
        
        # ==========================================================
        # CONFIGURA√á√ÉO DA RETRA√á√ÉO
        # ==========================================================
        {% set retract_after_purge = manual_retract if manual_retract >= 0 else default_retract %}
        
        # Mensagem sobre retra√ß√£o configurada
        {% if teste_mode == 0 %}
            {% if retract_after_purge > 0 %}
                RESPOND TYPE=command MSG="PURGA_MMU: Retra√ß√£o configurada: {retract_after_purge} mm"
            {% else %}
                RESPOND TYPE=command MSG="PURGA_MMU: ATEN√á√ÉO - Retra√ß√£o desabilitada (RETRACT=0)"
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: Modo teste {teste_mode} - Retra√ß√£o n√£o ser√° executada"
        {% endif %}
        
        # Obter n√∫mero de trocas de ferramenta
        {% set num_toolchanges = printer.mmu.num_toolchanges|default(0)|int %}
        
        # ==========================================================
        # DETEC√á√ÉO DE TROCA DE MATERIAL
        # ==========================================================
        {% set last_tool = printer.mmu.last_tool|default(-1)|int %}
        {% set material_changed = false %}
        {% set last_material = "" %}
        
        {% if last_tool >= 0 %}
            {% set gate_materials = printer.mmu.gate_material %}
            {% if gate_materials is defined and gate_materials is iterable %}
                {% set last_material = gate_materials[last_tool]|default("")|string|upper %}
                {% if last_material != "" and active_material != "" and last_material != active_material %}
                    {% set material_changed = true %}
                {% endif %}
            {% endif %}
        {% endif %}
        
        {% if debug %}
            RESPOND TYPE=command MSG="PURGA_MMU: √öltimo gate: {last_tool} | Material anterior: {last_material}"
            RESPOND TYPE=command MSG="PURGA_MMU: Material atual: {active_material} | Troca de material: {material_changed}"
        {% endif %}
        
        # ==========================================================
        # L√ìGICA DE DETERMINA√á√ÉO DO VOLUME DE PURGA
        # ==========================================================
        {% if manual_volume > 0 %}
            {% set purge_volume = manual_volume %}
            {% set volume_source = "manual" %}
            
        {% elif material_changed %}
            {% set purge_volume = material_change_purge_volume %}
            {% set volume_source = "troca_material" %}
            
            RESPOND TYPE=command MSG="PURGA_MMU: *** TROCA DE MATERIAL DETECTADA ***"
            RESPOND TYPE=command MSG="PURGA_MMU: {last_material} ‚Üí {active_material}"
            RESPOND TYPE=command MSG="PURGA_MMU: Volume fixo para limpeza: {purge_volume|round(1)}mm¬≥"
            RESPOND TYPE=command MSG="PURGA_MMU: (Ignorando mapa de purga e verifica√ß√£o de cor)"
            
        {% elif num_toolchanges == 0 %}
            # PRIMEIRA PURGA - VERIFICAR CORES
            {% set saved_remaining_color = printer["gcode_macro PRE_LOAD"].saved_remaining_color|string|replace('"', '') %}
            {% set saved_remaining_length = printer["gcode_macro PRE_LOAD"].saved_remaining_length|float %}
            {% set saved_active_color = printer["gcode_macro PRE_LOAD"].saved_active_color|string|replace('"', '') %}
            
            {% if debug %}
                RESPOND TYPE=command MSG="PURGA_MMU: Cor restante (salva): '{saved_remaining_color}' | Comprimento restante (salvo): {saved_remaining_length}mm"
                RESPOND TYPE=command MSG="PURGA_MMU: Cor ativa (salva): '{saved_active_color}'"
            {% endif %}
            
            {% if saved_remaining_color|lower == saved_active_color|lower and saved_remaining_color != "ffffff" and saved_active_color != "none" %}
                {% if saved_remaining_length > 0 %}
                    {% set optimized_length = saved_remaining_length * same_color_margin %}
                    {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}
                    {% set purge_volume = optimized_length * filament_area %}
                    {% set volume_source = "mesma_cor_otimizada" %}
                    
                    RESPOND TYPE=command MSG="PURGA_MMU: *** MESMA COR DETECTADA *** Filamento restante: {saved_remaining_length|round(1)}mm"
                    RESPOND TYPE=command MSG="PURGA_MMU: Cores: {saved_remaining_color} = {saved_active_color}"
                    RESPOND TYPE=command MSG="PURGA_MMU: Volume otimizado: {purge_volume|round(1)}mm¬≥ (economia de filamento!)"
                {% else %}
                    {% set purge_volume = first_purge_volume %}
                    {% set volume_source = "primeira_purga_fallback" %}
                    RESPOND TYPE=command MSG="PURGA_MMU: Mesma cor detectada, mas sem dados de comprimento v√°lidos. Usando volume padr√£o."
                {% endif %}
            {% else %}
                {% set purge_volume = first_purge_volume %}
                {% set volume_source = "primeira_purga_cor_diferente" %}
                
                {% if saved_remaining_color == "ffffff" or saved_active_color == "none" %}
                    RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Dados de cor indispon√≠veis. Volume padr√£o: {purge_volume|round(1)}mm¬≥"
                    RESPOND TYPE=command MSG="PURGA_MMU: DICA: Execute PRE_LOAD antes da troca para verifica√ß√£o de cor!"
                {% else %}
                    RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** Cores diferentes detectadas:"
                    RESPOND TYPE=command MSG="PURGA_MMU: Restante: {saved_remaining_color} ‚â† Ativa: {saved_active_color}"
                    RESPOND TYPE=command MSG="PURGA_MMU: Volume padr√£o: {purge_volume|round(1)}mm¬≥"
                {% endif %}
            {% endif %}
        {% else %}
            {% set purge_volume = printer.mmu.toolchange_purge_volume %}
            {% set volume_source = "normal" %}
        {% endif %}

        # ==========================================================
        # VERIFICA√á√ÉO DE DIVIS√ÉO DE PURGA
        # ==========================================================
        {% set needs_split = purge_volume > max_volume_per_cycle %}
        {% set num_purge_cycles = 2 if needs_split else 1 %}
        {% set volume_per_cycle = (purge_volume / 2) if needs_split else purge_volume %}
        
        {% if needs_split %}
            RESPOND TYPE=command MSG="PURGA_MMU: ‚ö†Ô∏è Volume grande detectado ({purge_volume|round(1)}mm¬≥ > {max_volume_per_cycle}mm¬≥)"
            RESPOND TYPE=command MSG="PURGA_MMU: üîÑ Dividindo em 2 ciclos completos de {volume_per_cycle|round(1)}mm¬≥ cada"
        {% endif %}

        {% set filament_area = 3.1416 * (filament_diameter/2)**2 %}

        {% if num_toolchanges == 0 %}
            RESPOND TYPE=command MSG="PURGA_MMU: *** PRIMEIRA PURGA *** - Trocas: {num_toolchanges} | Volume total: {purge_volume|round(1)} mm¬≥ | Fonte: {volume_source}"
        {% endif %}

        RESPOND TYPE=command MSG="PURGA_MMU: Purga: {purge_volume|round(1)} mm¬≥ total | Ciclos: {num_purge_cycles} | TESTE={teste_mode} | DEBUG={debug} | Fonte: {volume_source}"
        
        {% if debug %}
          RESPOND TYPE=command MSG="PURGA_MMU: Trocas de ferramenta: {num_toolchanges}"
          RESPOND TYPE=command MSG="PURGA_MMU: Material ativo: {active_material}"
          RESPOND TYPE=command MSG="PURGA_MMU: Velocidade de purga: {purge_feed} mm/min"
          RESPOND TYPE=command MSG="PURGA_MMU: Centro balde: X{bucket_x} Y{bucket_y}"
          RESPOND TYPE=command MSG="PURGA_MMU: √Årea escova: C1({brush_x1},{brush_y1}) C2({brush_x2},{brush_y2}) C3({brush_x3},{brush_y3}) C4({brush_x4},{brush_y4})"
          RESPOND TYPE=command MSG="PURGA_MMU: Mini-ciclos de purga: {purge_cycles}"
          RESPOND TYPE=command MSG="PURGA_MMU: Passadas de limpeza diagonal: {brush_strokes}"
          RESPOND TYPE=command MSG="PURGA_MMU: Retra√ß√£o ap√≥s purga: {retract_after_purge} mm"
          RESPOND TYPE=command MSG="PURGA_MMU: Necessita divis√£o: {needs_split} | Ciclos principais: {num_purge_cycles}"
        {% endif %}

        SAVE_GCODE_STATE NAME=PURGA_MMU_STATE

        {% set current_z = printer.toolhead.position.z %}
        {% if current_z < purge_z %}
          G90
          G1 Z{purge_z} F3000
        {% endif %}

        # ==========================================================
        # IN√çCIO DOS CICLOS DE PURGA
        # ==========================================================
        {% for main_cycle in range(num_purge_cycles) %}
            {% set cycle_num = main_cycle + 1 %}
            {% set purge_length = volume_per_cycle / filament_area %}
            {% set cycle_length = (purge_length / purge_cycles) if purge_cycles|int > 0 else 0 %}
            
            {% if num_purge_cycles > 1 %}
                RESPOND TYPE=command MSG="PURGA_MMU: ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                RESPOND TYPE=command MSG="PURGA_MMU: üîÑ CICLO {cycle_num}/2 - Volume: {volume_per_cycle|round(1)}mm¬≥ ({purge_length|round(1)}mm)"
                RESPOND TYPE=command MSG="PURGA_MMU: ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            {% endif %}

            # --- ABRE BANDEJA ---
            {% if teste_mode != 1 %}
              PURGE_SERVO_OPEN
              G4 P500
              {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Bandeja aberta" {% endif %}
            {% endif %}

            # --- PURGA NO BALDE ---
            G90
            MMU_SYNC_GEAR_MOTOR SYNC=1
            G1 X{bucket_x} Y{bucket_y} F7800
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Na posi√ß√£o do balde" {% endif %}

            {% if teste_mode == 0 %}
              # ===== IN√çCIO DA PURGA COM EXTRUS√ÉO =====
              G91  # Modo relativo para extrus√£o
              
              {% for i in range(purge_cycles|int) %}
                {% set x_offset = (bucket_spread / (purge_cycles - 1)) * i - (bucket_spread / 2) if purge_cycles > 1 else 0 %}
                {% set target_x = bucket_x + x_offset %}
                
                G90  # Modo absoluto para movimento XY
                G1 X{target_x} F7800
                {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num}.{i+1}: X{target_x|round(1)}" {% endif %}
                
                G91  # Modo relativo para extrus√£o
                G1 E{cycle_length|round(2)} F{purge_feed}
                G4 P200
              {% endfor %}
              
              # ===== RETRA√á√ÉO AP√ìS PURGA =====
              # Garantir que estamos em modo relativo
              G91
              
              {% if retract_after_purge|float > 0 %}
                RESPOND TYPE=command MSG="PURGA_MMU: >>> Ciclo {cycle_num} - Executando retra√ß√£o de {retract_after_purge} mm <<<"
                G1 E-{retract_after_purge|float} F2400
                G4 P100  # Pequena pausa para garantir execu√ß√£o
                RESPOND TYPE=command MSG="PURGA_MMU: >>> Ciclo {cycle_num} - Retra√ß√£o conclu√≠da <<<"
              {% else %}
                RESPOND TYPE=command MSG="PURGA_MMU: >>> ATEN√á√ÉO: Retra√ß√£o pulada (valor: {retract_after_purge}) <<<"
              {% endif %}
              
              # Voltar para modo absoluto
              G90
            {% else %}
              # Modo teste - sem extrus√£o
              RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Modo teste {teste_mode} - Pulando extrus√£o e retra√ß√£o"
            {% endif %}

            # --- LIMPEZA NA ESCOVA (MOVIMENTOS DIAGONAIS CRUZADOS) ---
            RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Iniciando limpeza diagonal na escova"
            
            # Movimento inicial para o primeiro canto (inferior esquerdo)
            G90
            G1 X{brush_x1} Y{brush_y1} F6000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Posi√ß√£o inicial - Canto 1: X{brush_x1} Y{brush_y1}" {% endif %}
            
            # Zigue-zague diagonal cruzado
            {% for i in range(brush_strokes|int) %}
                {% if i % 2 == 0 %}
                    # Diagonal ascendente: Canto 1 ‚Üí Canto 3 (esquerda-baixo ‚Üí direita-cima)
                    G1 X{brush_x3} Y{brush_y3} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/A - Diagonal ‚Üó (C1‚ÜíC3)" {% endif %}
                    # Move para Canto 2 (inferior direito)
                    G1 X{brush_x2} Y{brush_y2} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/B - Move para C2" {% endif %}
                    # Diagonal ascendente: Canto 2 ‚Üí Canto 4 (direita-baixo ‚Üí esquerda-cima)
                    G1 X{brush_x4} Y{brush_y4} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/C - Diagonal ‚Üñ (C2‚ÜíC4)" {% endif %}
                    # Retorna para Canto 1
                    G1 X{brush_x1} Y{brush_y1} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/D - Retorna C1" {% endif %}
                {% else %}
                    # Diagonal descendente: Canto 4 ‚Üí Canto 2 (esquerda-cima ‚Üí direita-baixo)
                    G1 X{brush_x4} Y{brush_y4} F3000
                    G1 X{brush_x2} Y{brush_y2} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/A - Diagonal ‚Üò (C4‚ÜíC2)" {% endif %}
                    # Move para Canto 3 (superior direito)
                    G1 X{brush_x3} Y{brush_y3} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/B - Move para C3" {% endif %}
                    # Diagonal descendente: Canto 3 ‚Üí Canto 1 (direita-cima ‚Üí esquerda-baixo)
                    G1 X{brush_x1} Y{brush_y1} F3000
                    {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} Stroke {i+1}/C - Diagonal ‚Üô (C3‚ÜíC1)" {% endif %}
                {% endif %}
            {% endfor %}

            # --- WIPE FINAL ---
            # Sai pela direita da escova (lateral, n√£o para cima)
            {% set exit_x = brush_x3 + wipe_offset %}
            {% set exit_y = (brush_y3 + brush_y2) / 2 %}
            G90
            G1 X{exit_x} Y{exit_y} F3000
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Sa√≠da lateral - X{exit_x|round(1)} Y{exit_y|round(1)}" {% endif %}

            # --- SAFE POSITION (necess√°rio antes de fechar bandeja) ---
            G1 X{safe_x} Y{safe_y} F7800
            {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Posi√ß√£o segura alcan√ßada" {% endif %}

            # --- RECOLHE BANDEJA (esvazia o balde) ---
            {% if teste_mode != 1 %}
              PURGE_SERVO_CLOSE
              G4 P500
              {% if debug %} RESPOND TYPE=command MSG="PURGA_MMU: Ciclo {cycle_num} - Bandeja fechada (balde esvaziado)" {% endif %}
            {% endif %}
            
            {% if num_purge_cycles > 1 %}
                RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Ciclo {cycle_num}/2 conclu√≠do"
                {% if cycle_num < num_purge_cycles %}
                    G4 P1000  # Pausa entre ciclos para garantir estabilidade
                {% endif %}
            {% endif %}
        {% endfor %}
        # ==========================================================
        # FIM DOS CICLOS DE PURGA
        # ==========================================================

        RESTORE_GCODE_STATE NAME=PURGA_MMU_STATE
        RESPOND TYPE=command MSG="PURGA_MMU: Perfil SKEW carregado ap√≥s a purga"
        SKEW_PROFILE LOAD=skew_profile
        
        # Mensagem final de confirma√ß√£o
        {% if teste_mode == 0 %}
            {% if retract_after_purge > 0 %}
                {% if num_purge_cycles > 1 %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì {num_purge_cycles} ciclos de purga e retra√ß√£o conclu√≠dos com sucesso"
                {% else %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Purga e retra√ß√£o conclu√≠das com sucesso"
                {% endif %}
            {% else %}
                {% if num_purge_cycles > 1 %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì {num_purge_cycles} ciclos de purga conclu√≠dos (sem retra√ß√£o)"
                {% else %}
                    RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Purga conclu√≠da (sem retra√ß√£o)"
                {% endif %}
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="PURGA_MMU: ‚úì Teste de movimentos conclu√≠do ({num_purge_cycles} ciclo(s))"
        {% endif %}
    {% endif %}

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïë  ‚ïö‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
#‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó   ‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
#‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù 


# Macro para abrir o servo de corte de filamento
[gcode_macro CUTTING_SERVO_OPEN]
gcode:
    _CUT_TIP_GANTRY_SERVO_DOWN

# Macro para fechar o servo de corte de filamento
[gcode_macro CUTTING_SERVO_CLOSE]
gcode:
    _CUT_TIP_GANTRY_SERVO_UP

#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
#‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë       ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
#‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù        ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 

[gcode_macro DUMP_VARIABLES]
description: >
    Isso exibe todas as vari√°veis atuais do Klipper no terminal de c√≥digo G.
    Isso ajuda a encontrar vari√°veis de sistema do Klipper para uso em macros. √â poss√≠vel aplicar um filtro tanto por nome quanto por valor.
    Argumentos
        NAME (string) - Filtrar resultados com base no nome (mostrar apenas vari√°veis com nomes que contenham esta string)
        VALUE (string) - Filtrar resultados com base no valor (mostrar apenas valores que contenham esse valor)
        SHOW_CFG (n√∫mero inteiro, 0-1) - Defina como 1 para incluir toda a configura√ß√£o na sa√≠da. O padr√£o √© 0 (configura√ß√£o filtrada).
    Exemplos
        DUMP_VARIABLES: Retorna todas as vari√°veis (exceto ` printer['configfile'].configand` printer['configfile'].settings, pois elas cont√™m toda a configura√ß√£o).
        DUMP_VARIABLES NAME=stepperRetorna todas as vari√°veis que cont√™m a string stepperem seus nomes.
        DUMP_VARIABLES VALUE=extruderRetorna todas as vari√°veis que cont√™m a string extruderem seu valor.
        DUMP_VARIABLES NAME=stepper VALUE=extruderRetorna todas as vari√°vei que t√™m a string stepperem seu nome e a string extruderem seu valor.
        DUMP_VARIABLES SHOW_CFG=1Retorna todas as vari√°veis, incluindo a configura√ß√£o.
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    
    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {action_respond_info(out|join("\n"))}

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
#‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
#‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë    ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
#‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[gcode_macro GET_VARIABLE]
description: >
 Esta fun√ß√£o retorna o valor e o tipo de uma √∫nica vari√°vel para o terminal de c√≥digo G. 
 Chaves e √≠ndices podem ser encadeados para acessar dicion√°rios e listas aninhados.
 Exemplos:
    GET_VARIABLE NAME=toolhead: Retorna o valor e o tipo da vari√°vel printer.toolhead.
    GET_VARIABLE NAME=bed_mesh.profiles.default.points.1.0: Retorna o valor e o tipo da vari√°vel printer.bed_mesh.profiles.default.points[1][0].
gcode:
    {% set names = (params.NAME).split('.')|list %}
    {% set join = (params.JOIN)|default(1)|int %}
    
    {% set _dummy0 = namespace( break = 0 ) %}
    {% set _dummy1 = namespace( out = printer[names|first] ) %}
    
    {% for name in names if _dummy0.break == 0 %}
        {% if loop.index > 1 %}
            {% if name in _dummy1.out %}
                {% set _dummy1.out = _dummy1.out[name] %}
            {% elif name[0] in '0123456789' and _dummy1.out is iterable and _dummy1.out is not string and _dummy1.out is not mapping and _dummy1.out|length > name[0]|int %}
                {% set _dummy1.out = _dummy1.out[name|int] %}
            {% else %}
                {% set _dummy0.break = loop.index0 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    {% if _dummy1.out is boolean %}
        { action_respond_info('Type: boolean') }
    {% elif _dummy1.out is float %}
        { action_respond_info('Type: float') }
    {% elif _dummy1.out is integer %}
        { action_respond_info('Type: integer') }
    {% elif _dummy1.out is mapping %}
        { action_respond_info('Type: mapping') }
    {% elif _dummy1.out is string %}
        { action_respond_info('Type: string') }
    {% elif _dummy1.out is iterable %}
        { action_respond_info('Type: iterable') }
    {% elif _dummy1.out is none %}
        { action_respond_info('Type: none') }
    {% elif _dummy1.out is undefined %}
        { action_respond_info('Type: undefined') }
    {% elif _dummy1.out is callable %}
        { action_respond_info('Type: callable') }
    {% else %}
        { action_respond_info('Type: unknown') }
    {% endif %}
    
    {% if join and _dummy1.out is iterable and _dummy1.out is not string and _dummy1.out is not mapping %}
        { action_respond_info('%s' % _dummy1.out|join("\n")) }
    {% else %}
        { action_respond_info('%s' % _dummy1.out) }
    {% endif %}
    
    {% if _dummy0.break != 0 %}
        { action_respond_info('"printer.%s" does not contain "%s"!' % (names[0:_dummy0.break]|join('.'), names[_dummy0.break])) }
    {% endif %}

#‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó
#‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë
#   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë
#   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù

[gcode_macro user_pause_extension ]
description: Envia uma notifica√ß√£o para o bot telegram quando a imporess√£o for pausada
gcode:
    RESPOND PREFIX=tgnotify MSG="Impress√£o pausada"

[gcode_macro user_resume_extension ]
description: Envia uma notifica√ß√£o para o bot telegram quando a imporess√£o for retomada
gcode:
    RESPOND PREFIX=tgnotify MSG="Impress√£o retomada"
   